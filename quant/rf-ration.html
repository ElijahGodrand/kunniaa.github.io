<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A股所有股票最近一天的跌涨幅度统计表</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .sort-arrow {
            display: inline-block;
            width: 0;
            height: 0;
            margin-left: 4px;
            vertical-align: middle;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
        }
        .sort-asc {
            border-bottom: 4px solid currentColor;
            border-top: none;
        }
        .sort-desc {
            border-top: 4px solid currentColor;
            border-bottom: none;
        }
        .table-row:hover {
            background-color: #f3f4f6;
        }
        .table-row.selected {
            background-color: #bfdbfe;
        }
        .table-row.selected:hover {
            background-color: #93c5fd;
        }
        .stocks-link {
            color: #2563eb;
            text-decoration: none;
        }
        .stocks-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col p-4 overflow-hidden">
    <div class="max-w-7xl mx-auto w-full flex flex-col h-full">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-2 flex-shrink-0">A股所有股票最近一天的跌涨幅度统计表</h1>
        <p id="date-display" class="text-center text-gray-600 mb-1 flex-shrink-0">统计时间：加载中...</p>
        <p class="text-center text-xs text-gray-400 mb-4 flex-shrink-0">数据量大，计算、滚动和排序略有卡顿</p>
        
        <div class="flex items-center justify-center mb-4 flex-shrink-0">
            <label class="flex items-center space-x-2 text-sm text-gray-700 cursor-pointer">
                <input type="checkbox" id="sort-by-swii" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                <span>先按申万二级行业分类分配排序，再按照点击表头排序</span>
            </label>
        </div>

        <div class="bg-white rounded-lg shadow overflow-hidden flex-grow flex flex-col">
            <div class="overflow-x-auto overflow-y-auto flex-grow">
                <table class="w-full text-sm">
                    <thead class="bg-gray-100 sticky top-0 z-10">
                        <tr>
                            <th class="px-3 py-2 text-left font-semibold text-gray-700 cursor-pointer whitespace-nowrap" data-column="code">
                                股票代码<span class="sort-arrow"></span>
                            </th>
                            <th class="px-3 py-2 text-left font-semibold text-gray-700 cursor-pointer whitespace-nowrap" data-column="name">
                                股票名称<span class="sort-arrow"></span>
                            </th>
                            <th class="px-3 py-2 text-right font-semibold text-gray-700 cursor-pointer whitespace-nowrap" data-column="market_cap">
                                总市值(亿)<span class="sort-arrow"></span>
                            </th>
                            <th class="px-3 py-2 text-left font-semibold text-gray-700 cursor-pointer whitespace-nowrap" data-column="swii" id="swii-header">
                                申万二级分类<span class="sort-arrow"></span>
                            </th>
                            <th class="px-3 py-2 text-right font-semibold text-gray-700 cursor-pointer whitespace-nowrap" data-column="rf_ratio">
                                跌涨幅(%)<span class="sort-arrow"></span>
                            </th>
                            <th class="px-3 py-2 text-right font-semibold text-gray-700 cursor-pointer whitespace-nowrap" data-column="minimax_ratio">
                                振幅(%)<span class="sort-arrow"></span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let stockData = [];
        let currentSort = { column: null, direction: 'asc' };
        let precomputedSorts = {};
        
        // 格式化数字，保留两位小数
        function formatNumber(num) {
            if (num === null || num === undefined) return '-';
            return Number(num).toFixed(2);
        }
        
        // 格式化日期
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}年${month}月${day}日`;
        }
        
        // 获取股票代码（去掉.XSHE/.XSHG后缀）
        function getStockCode(fullCode) {
            return fullCode.replace(/\.XSHE$/, '').replace(/\.XSHG$/, '');
        }
        
        // 生成雪球链接
        function getXueqiuLink(marketName, code) {
            const prefix = marketName === 'SZ' ? 'SZ' : 'SH';
            const shortCode = getStockCode(code);
            return `https://xueqiu.com/S/${prefix}${shortCode}`;
        }
        
        // 比较函数
        function compareValues(a, b, column, direction) {
            let valA = a[column];
            let valB = b[column];
            
            if (valA === null || valA === undefined) valA = '';
            if (valB === null || valB === undefined) valB = '';
            
            if (typeof valA === 'string') valA = valA.toLowerCase();
            if (typeof valB === 'string') valB = valB.toLowerCase();
            
            if (valA < valB) return direction === 'asc' ? -1 : 1;
            if (valA > valB) return direction === 'asc' ? 1 : -1;
            return 0;
        }
        
        // 预计算所有排序
        function precomputeSorts() {
            const columns = ['code', 'name', 'market_cap', 'swii', 'rf_ratio', 'minimax_ratio'];
            
            columns.forEach(column => {
                precomputedSorts[`${column}_asc`] = [...stockData].sort((a, b) => compareValues(a, b, column, 'asc'));
                precomputedSorts[`${column}_desc`] = [...stockData].sort((a, b) => compareValues(a, b, column, 'desc'));
                
                // 按申万二级分类排序的组合
                precomputedSorts[`swii_${column}_asc`] = [...stockData].sort((a, b) => {
                    const swiiCompare = compareValues(a, b, 'swii', 'asc');
                    if (swiiCompare !== 0) return swiiCompare;
                    return compareValues(a, b, column, 'asc');
                });
                
                precomputedSorts[`swii_${column}_desc`] = [...stockData].sort((a, b) => {
                    const swiiCompare = compareValues(a, b, 'swii', 'asc');
                    if (swiiCompare !== 0) return swiiCompare;
                    return compareValues(a, b, column, 'desc');
                });
            });
        }
        
        // 渲染表格
        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            const fragment = document.createDocumentFragment();
            
            data.forEach((stock, index) => {
                const row = document.createElement('tr');
                row.className = 'table-row transition-colors duration-150 cursor-pointer';
                row.dataset.index = index;
                
                const codeCell = document.createElement('td');
                codeCell.className = 'px-3 py-2 whitespace-nowrap font-mono text-xs';
                const link = document.createElement('a');
                link.href = getXueqiuLink(stock.market_name, stock.code);
                link.target = '_blank';
                link.className = 'stocks-link';
                link.textContent = stock.code;
                link.onclick = (e) => e.stopPropagation();
                codeCell.appendChild(link);
                
                const nameCell = document.createElement('td');
                nameCell.className = 'px-3 py-2 whitespace-nowrap';
                nameCell.textContent = stock.name;
                
                const capCell = document.createElement('td');
                capCell.className = 'px-3 py-2 whitespace-nowrap text-right font-mono';
                capCell.textContent = formatNumber(stock.market_cap);
                
                const swiiCell = document.createElement('td');
                swiiCell.className = 'px-3 py-2 whitespace-nowrap';
                swiiCell.textContent = stock.swii;
                
                const rfCell = document.createElement('td');
                rfCell.className = 'px-3 py-2 whitespace-nowrap text-right font-mono';
                rfCell.textContent = formatNumber(stock.rf_ratio);
                rfCell.style.color = stock.rf_ratio > 0 ? '#dc2626' : stock.rf_ratio < 0 ? '#16a34a' : '#374151';
                
                const minimaxCell = document.createElement('td');
                minimaxCell.className = 'px-3 py-2 whitespace-nowrap text-right font-mono';
                minimaxCell.textContent = formatNumber(stock.minimax_ratio);
                
                row.appendChild(codeCell);
                row.appendChild(nameCell);
                row.appendChild(capCell);
                row.appendChild(swiiCell);
                row.appendChild(rfCell);
                row.appendChild(minimaxCell);
                
                row.addEventListener('click', function() {
                    document.querySelectorAll('.table-row').forEach(r => r.classList.remove('selected'));
                    this.classList.add('selected');
                });
                
                fragment.appendChild(row);
            });
            
            tbody.appendChild(fragment);
        }
        
        // 更新排序箭头
        function updateSortArrows(column, direction) {
            document.querySelectorAll('th .sort-arrow').forEach(arrow => {
                arrow.className = 'sort-arrow';
            });
            
            const activeHeader = document.querySelector(`th[data-column="${column}"]`);
            if (activeHeader) {
                const arrow = activeHeader.querySelector('.sort-arrow');
                arrow.className = `sort-arrow ${direction === 'asc' ? 'sort-asc' : 'sort-desc'}`;
            }
        }
        
        // 处理排序
        function handleSort(column) {
            const sortBySwii = document.getElementById('sort-by-swii').checked;
            
            // 如果勾选了按申万二级分类排序，且点击的是swii列，则忽略
            if (sortBySwii && column === 'swii') {
                return;
            }
            
            // 确定排序方向
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            let sortedData;
            if (sortBySwii) {
                const key = `swii_${column}_${currentSort.direction}`;
                sortedData = precomputedSorts[key] || stockData;
            } else {
                const key = `${column}_${currentSort.direction}`;
                sortedData = precomputedSorts[key] || stockData;
            }
            
            renderTable(sortedData);
            updateSortArrows(column, currentSort.direction);
        }
        
        // 初始化
        async function init() {
            try {
                const response = await fetch('./No-016-res.json');
                const data = await response.json();
                
                // 显示日期
                const dateDisplay = document.getElementById('date-display');
                dateDisplay.textContent = `统计时间：${formatDate(data.info.end_dt)}`;
                
                // 解析股票数据
                stockData = [];
                for (const [code, info] of Object.entries(data)) {
                    if (code === 'info') continue;
                    stockData.push({
                        code: code,
                        name: info.name,
                        market_cap: info.market_cap,
                        market_name: info.market_name,
                        swii: info.swii,
                        rf_ratio: info.rf_ratio,
                        minimax_ratio: info.minimax_ratio
                    });
                }
                
                // 预计算所有排序
                precomputeSorts();
                
                // 初始渲染
                renderTable(stockData);
                
                // 绑定表头点击事件
                document.querySelectorAll('th[data-column]').forEach(th => {
                    th.addEventListener('click', function() {
                        const column = this.dataset.column;
                        handleSort(column);
                    });
                });
                
                // 绑定复选框事件
                document.getElementById('sort-by-swii').addEventListener('change', function() {
                    const swiiHeader = document.getElementById('swii-header');
                    if (this.checked) {
                        swiiHeader.style.cursor = 'not-allowed';
                        swiiHeader.classList.add('text-gray-400');
                        swiiHeader.classList.remove('cursor-pointer');
                    } else {
                        swiiHeader.style.cursor = 'pointer';
                        swiiHeader.classList.remove('text-gray-400');
                        swiiHeader.classList.add('cursor-pointer');
                    }
                    
                    // 如果当前按swii排序，取消排序
                    if (currentSort.column === 'swii') {
                        currentSort.column = null;
                        currentSort.direction = 'asc';
                        document.querySelectorAll('.sort-arrow').forEach(arrow => {
                            arrow.className = 'sort-arrow';
                        });
                    }
                });
                
                // 点击空白处取消选中
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('table')) {
                        document.querySelectorAll('.table-row').forEach(r => r.classList.remove('selected'));
                    }
                });
                
            } catch (error) {
                console.error('加载数据失败:', error);
                document.getElementById('table-body').innerHTML = `
                    <tr>
                        <td colspan="6" class="px-3 py-4 text-center text-red-600">
                            加载数据失败，请确保 No-016-res.json 文件存在且可访问
                        </td>
                    </tr>
                `;
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
