<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A股所有股票按照申万二级行业分类并按照市值排序</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 自定义样式 */
        .stock-row:hover {
            background-color: #f8fafc;
        }
        .sector-nav {
            scroll-behavior: smooth;
        }
        .sector-card {
            transition: all 0.3s ease;
        }
        .sector-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .back-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }
        /* 移动设备表格优化 */
        @media (max-width: 768px) {
            .table-container {
                overflow-x: auto;
            }
            table {
                min-width: 640px;
            }
        }
        /* 加载进度条 */
        .progress-bar {
            height: 4px;
            background-color: #3b82f6;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <!-- 加载进度条 -->
    <div id="loading-progress" class="progress-bar fixed top-0 left-0 z-50"></div>

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- 页面标题区域 -->
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
                A股所有股票按照申万二级行业分类并按照市值排序
            </h1>
            <div class="text-sm text-gray-600 mb-2">
                数据较大，显示略卡
            </div>
            <div class="text-sm text-gray-600 mb-4" id="market-cap-date">
                市值获取时间：加载中...
            </div>

            <!-- 行业搜索框 -->
            <!--div class="max-w-md mx-auto mb-6">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <input type="text" id="sector-search"
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none transition-all"
                           placeholder="数据加载中..."
                           disabled>
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                        <span id="sector-count" class="text-gray-500 text-sm">加载中...</span>
                    </div>
                </div>
        </div -->
        </header>

        <!-- 申万二级行业导航 -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-10">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-list mr-2 text-blue-500"></i>
                申万二级行业分类导航
            </h2>
            <div class="sector-nav flex flex-wrap gap-2" id="sector-nav">
                <!-- 行业导航链接将在这里动态生成 -->
                <div class="text-gray-500">正在加载行业分类...</div>
            </div>
        </div>

        <!-- 股票数据展示区域 -->
        <div id="sectors-container">
            <!-- 行业数据将在这里动态生成 -->
            <div class="text-center py-10">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                <p class="mt-4 text-gray-600">正在加载股票数据...</p>
            </div>
        </div>

        <!-- 回到顶部按钮 -->
        <button id="back-to-top" class="back-to-top hidden bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-full shadow-lg transition-all duration-300">
            <i class="fas fa-arrow-up"></i>
        </button>

        <!-- 隐藏的文件输入（用于手动加载） -->
        <input type="file" id="file-input" accept=".json" class="hidden">

        <!-- 文件选择模态对话框 -->
        <div id="file-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4">
                <div class="p-6">
                    <div class="flex items-center mb-4">
                        <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-exclamation-triangle text-red-500"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">数据加载失败</h3>
                            <p class="text-sm text-gray-600">自动加载因浏览器安全限制而失败</p>
                        </div>
                    </div>

                    <div class="mb-6">
                        <p class="text-gray-700 mb-3">由于浏览器安全策略，无法自动加载本地数据文件。</p>
                        <p class="text-gray-700 mb-4">请手动选择数据文件继续：</p>

                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <div class="flex items-center text-blue-800">
                                <i class="fas fa-info-circle mr-2"></i>
                                <span class="text-sm">请选择文件：<span class="font-medium">No-008-res.json</span></span>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-3">
                        <button id="modal-select-file" class="flex-1 px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-colors flex items-center justify-center">
                            <i class="fas fa-file-import mr-2"></i>选择JSON文件
                        </button>
                        <button id="modal-retry-auto" class="flex-1 px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg font-medium transition-colors flex items-center justify-center">
                            <i class="fas fa-redo mr-2"></i>重试自动加载
                        </button>
                    </div>

                    <div class="mt-4 text-center">
                        <p class="text-xs text-gray-500">在线部署时自动加载会正常工作，本地使用时需手动选择文件</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局数据变量
        let stockData = null;
        let sectors = [];

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            setupBackToTop();
            // 页面加载后立即尝试自动加载数据
            autoLoadData();
        });

        // 设置事件监听器
        function setupEventListeners() {
            // 文件选择输入
            const fileInput = document.getElementById('file-input');
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }

            // 模态对话框按钮
            const modalSelectFileBtn = document.getElementById('modal-select-file');
            if (modalSelectFileBtn) {
                modalSelectFileBtn.addEventListener('click', function() {
                    // 触发隐藏的文件输入点击
                    fileInput.click();
                    // 隐藏模态对话框（文件选择后会处理）
                });
            }

            const modalRetryAutoBtn = document.getElementById('modal-retry-auto');
            if (modalRetryAutoBtn) {
                modalRetryAutoBtn.addEventListener('click', function() {
                    // 隐藏模态对话框并重试自动加载
                    hideFileModal();
                    autoLoadData();
                });
            }

            // 初始显示状态 - 直接进入加载状态
            updateLoadingState('loading');
        }

        // 自动加载数据
        async function autoLoadData() {
            updateLoadingState('loading');
            try {
                await loadDataFromUrl('No-008-res.json');
            } catch (error) {
                console.error('自动加载失败:', error);
                // 显示文件选择模态对话框
                showFileModal();
                updateLoadingState('error');
            }
        }

        // 显示文件选择模态对话框
        function showFileModal() {
            const modal = document.getElementById('file-modal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        // 隐藏文件选择模态对话框
        function hideFileModal() {
            const modal = document.getElementById('file-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // 处理文件选择
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            updateLoadingState('loading');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    processFileData(data);
                    // 文件加载成功，隐藏模态对话框
                    hideFileModal();
                } catch (error) {
                    console.error('文件解析失败:', error);
                    showError('文件解析失败: ' + error.message + '<br>请确保选择正确的JSON文件格式。');
                    updateLoadingState('error');
                }
            };
            reader.onerror = function(error) {
                console.error('文件读取失败:', error);
                showError('文件读取失败: ' + error.message);
                updateLoadingState('error');
            };
            reader.readAsText(file);
        }

        // 从URL加载数据
        async function loadDataFromUrl(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP错误! 状态码: ${response.status}`);
                }
                stockData = await response.json();
                processFileData(stockData);
            } catch (error) {
                console.error('从URL加载数据失败:', error);
                throw error;
            }
        }

        // 处理文件数据
        function processFileData(data) {
            if (!data || typeof data !== 'object') {
                throw new Error('无效的JSON数据格式');
            }

            if (!data.info) {
                throw new Error('JSON数据缺少info字段');
            }

            stockData = data;
            processData();
        }

        // 更新加载状态
        function updateLoadingState(state) {
            const searchInput = document.getElementById('sector-search');
            const loadingElements = document.getElementById('sectors-container');

            switch (state) {
                case 'loading':
                    if (searchInput) searchInput.disabled = true;
                    if (loadingElements) {
                        loadingElements.innerHTML = `
                            <div class="text-center py-10">
                                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                                <p class="mt-4 text-gray-600">正在加载股票数据...</p>
                            </div>
                        `;
                    }
                    break;

                case 'error':
                    if (searchInput) searchInput.disabled = true;
                    break;

                case 'loaded':
                    if (searchInput) searchInput.disabled = false;
                    break;
            }
        }

        // 显示错误信息
        function showError(message) {
            document.getElementById('market-cap-date').innerHTML =
                '<span class="text-red-500">数据加载失败</span>';
            document.getElementById('sector-nav').innerHTML =
                '<div class="text-red-500">数据加载失败</div>';
            document.getElementById('sectors-container').innerHTML =
                `<div class="text-red-500 p-4 bg-red-50 rounded">${message}</div>`;
        }


        // 处理数据
        function processData() {
            // 更新市值获取时间
            if (stockData.info && stockData.info.market_cap_date) {
                document.getElementById('market-cap-date').textContent =
                    `市值获取时间：${stockData.info.market_cap_date}`;
            }

            // 提取所有行业分类（排除info）
            sectors = Object.keys(stockData).filter(key => key !== 'info');
            sectors.sort(); // 按字母顺序排序

            // 更新行业计数
            updateSectorCount();

            // 启用搜索框
            enableSectorSearch();

            // 更新加载进度
            updateProgress(50);

            // 生成导航
            generateSectorNavigation();

            // 更新加载进度
            updateProgress(80);

            // 生成行业详情
            generateSectorDetails();

            // 完成加载
            updateProgress(100);
            setTimeout(() => {
                document.getElementById('loading-progress').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loading-progress').style.display = 'none';
                }, 300);
            }, 500);

            // 更新加载状态
            updateLoadingState('loaded');
        }

        // 更新行业计数
        function updateSectorCount() {
            const countElement = document.getElementById('sector-count');
            if (countElement && sectors.length > 0) {
                countElement.textContent = `${sectors.length} 个行业`;
            }
        }

        // 启用行业搜索
        function enableSectorSearch() {
            const searchInput = document.getElementById('sector-search');
            if (!searchInput) return;

            // 启用输入框
            searchInput.disabled = false;
            searchInput.placeholder = `搜索 ${sectors.length} 个申万二级行业分类...`;

            // 如果还没有添加事件监听，则添加
            if (!searchInput.hasEventListener) {
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    filterSectors(searchTerm);
                });
                searchInput.hasEventListener = true;
            }

            // 添加清除按钮（如果还没有）
            const searchContainer = searchInput.parentElement;
            const existingClearButton = searchContainer.querySelector('.clear-search-btn');
            if (!existingClearButton) {
                const clearButton = document.createElement('button');
                clearButton.type = 'button';
                clearButton.className = 'clear-search-btn absolute inset-y-0 right-10 pr-3 flex items-center text-gray-400 hover:text-gray-600 focus:outline-none';
                clearButton.innerHTML = '<i class="fas fa-times"></i>';
                clearButton.title = '清除搜索';
                clearButton.addEventListener('click', function() {
                    searchInput.value = '';
                    searchInput.focus();
                    filterSectors('');
                });
                searchContainer.appendChild(clearButton);
            }
        }

        // 筛选行业
        function filterSectors(searchTerm) {
            const navContainer = document.getElementById('sector-nav');
            const sectorCards = document.querySelectorAll('.sector-card');

            if (!searchTerm) {
                // 显示所有行业
                navContainer.querySelectorAll('a').forEach(link => {
                    link.classList.remove('hidden');
                });
                sectorCards.forEach(card => {
                    card.classList.remove('hidden');
                });
                updateSectorCount();
                return;
            }

            // 筛选导航链接
            let visibleCount = 0;
            navContainer.querySelectorAll('a').forEach(link => {
                const sectorNameElement = link.querySelector('.sector-name');
                const sectorName = sectorNameElement ? sectorNameElement.textContent.toLowerCase() : link.textContent.toLowerCase();
                if (sectorName.includes(searchTerm)) {
                    link.classList.remove('hidden');
                    visibleCount++;
                } else {
                    link.classList.add('hidden');
                }
            });

            // 筛选行业卡片
            sectorCards.forEach(card => {
                const sectorName = card.querySelector('h3').textContent.toLowerCase();
                if (sectorName.includes(searchTerm)) {
                    card.classList.remove('hidden');
                } else {
                    card.classList.add('hidden');
                }
            });

            // 更新计数显示
            const countElement = document.getElementById('sector-count');
            if (countElement) {
                countElement.textContent = `${visibleCount}/${sectors.length} 个行业`;
            }
        }

        // 更新加载进度
        function updateProgress(percent) {
            const progressBar = document.getElementById('loading-progress');
            if (progressBar) {
                progressBar.style.width = `${percent}%`;
            }
        }

        // 生成行业导航
        function generateSectorNavigation() {
            const navContainer = document.getElementById('sector-nav');
            navContainer.innerHTML = '';

            sectors.forEach(sector => {
                const sectorId = sector.replace(/[^\w\u4e00-\u9fa5]/g, '-');
                const button = document.createElement('a');
                button.href = `#sector-${sectorId}`;
                button.className = 'inline-flex items-center px-4 py-2 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-full text-sm font-medium transition-colors duration-200';
                button.innerHTML = `<i class="fas fa-link mr-2 text-xs"></i><span class="sector-name">${sector}</span>`;
                button.title = `跳转到 ${sector}`;
                navContainer.appendChild(button);
            });
        }

        // 生成行业详情
        function generateSectorDetails() {
            const container = document.getElementById('sectors-container');
            container.innerHTML = '';

            sectors.forEach(sector => {
                const sectorId = sector.replace(/[^\w\u4e00-\u9fa5]/g, '-');
                const sectorData = stockData[sector];

                // 创建行业卡片
                const sectorCard = document.createElement('div');
                sectorCard.className = 'sector-card bg-white rounded-xl shadow-md mb-8 overflow-hidden';
                sectorCard.id = `sector-${sectorId}`;

                // 行业标题
                const header = document.createElement('div');
                header.className = 'bg-gradient-to-r from-blue-500 to-blue-600 p-5 text-white';
                header.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-xl font-bold">${sector}</h3>
                            <p class="text-blue-100 text-sm mt-1">共 ${sectorData.length} 只股票</p>
                        </div>
                        <a href="#top" class="bg-white/20 hover:bg-white/30 text-white p-2 rounded-full transition-colors" title="返回顶部">
                            <i class="fas fa-arrow-up"></i>
                        </a>
                    </div>
                `;

                // 股票表格
                const tableContainer = document.createElement('div');
                tableContainer.className = 'p-5 table-container';

                const table = document.createElement('table');
                table.className = 'w-full';
                table.innerHTML = `
                    <thead>
                        <tr class="border-b border-gray-200">
                            <th class="py-3 px-4 text-left font-semibold text-gray-700 w-16">排名</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-700">股票代码</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-700">股票名称</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-700">股票市值（${stockData.info.market_cap_unit || '亿'}）</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-${sectorId}">
                        <!-- 股票行将动态生成 -->
                    </tbody>
                `;

                // 生成股票行
                const tbody = table.querySelector(`#tbody-${sectorId}`);
                sectorData.forEach((stock, index) => {
                    const row = document.createElement('tr');
                    row.className = 'stock-row border-b border-gray-100 hover:bg-gray-50 transition-colors';

                    // 格式化市值（保留两位小数）
                    const marketCap = typeof stock.market_cap === 'number'
                        ? stock.market_cap.toFixed(2)
                        : stock.market_cap;

                    // 解析股票代码，生成雪球链接
                    const stockCode = stock.index || '';
                    let xueqiuLink = '';
                    let displayCode = stockCode;

                    if (stockCode) {
                        const parts = stockCode.split('.');
                        if (parts.length === 2) {
                            const code = parts[0];
                            const exchange = parts[1];
                            let marketPrefix = '';

                            if (exchange === 'XSHG' || stock.market_name === 'SH') {
                                marketPrefix = 'SH';
                            } else if (exchange === 'XSHE' || stock.market_name === 'SZ') {
                                marketPrefix = 'SZ';
                            }

                            if (marketPrefix) {
                                xueqiuLink = `https://xueqiu.com/S/${marketPrefix}${code}`;
                                displayCode = `${code}.${exchange}`;
                            }
                        }
                    }

                    // 创建股票代码单元格（带链接）
                    let codeCellContent = displayCode;
                    if (xueqiuLink) {
                        codeCellContent = `<a href="${xueqiuLink}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline font-medium">${displayCode}</a>`;
                    }

                    row.innerHTML = `
                        <td class="py-3 px-4 text-gray-600 font-medium">${index + 1}</td>
                        <td class="py-3 px-4 font-mono">${codeCellContent}</td>
                        <td class="py-3 px-4">${stock.display_name || '未知'}</td>
                        <td class="py-3 px-4 font-medium text-gray-900">${marketCap}</td>
                    `;

                    tbody.appendChild(row);
                });

                tableContainer.appendChild(table);
                sectorCard.appendChild(header);
                sectorCard.appendChild(tableContainer);
                container.appendChild(sectorCard);
            });
        }

        // 设置回到顶部按钮
        function setupBackToTop() {
            const backToTopBtn = document.getElementById('back-to-top');

            window.addEventListener('scroll', () => {
                if (window.pageYOffset > 300) {
                    backToTopBtn.classList.remove('hidden');
                } else {
                    backToTopBtn.classList.add('hidden');
                }
            });

            backToTopBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }

        // 辅助函数：平滑滚动到元素
        function scrollToElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth' });
            }
        }
    </script>
</body>
</html>
