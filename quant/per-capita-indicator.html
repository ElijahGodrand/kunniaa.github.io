<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A股所有股票人均指标统计表</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        th[data-field]::after {
            content: '';
            display: inline-block;
            margin-left: 4px;
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            vertical-align: middle;
        }
        .sort-arrow::after {
            border-top: 4px solid #9ca3af;
            border-bottom: 4px solid #9ca3af;
            height: 2px;
            background: transparent;
        }
        .sort-asc::after {
            border-bottom: 5px solid #3b82f6;
            border-top: none;
            background: transparent;
        }
        .sort-desc::after {
            border-top: 5px solid #3b82f6;
            border-bottom: none;
            background: transparent;
        }
        .highlighted {
            background-color: #fef08a !important;
        }
        .highlighted td {
            background-color: #fef08a !important;
        }
        th {
            cursor: pointer;
            user-select: none;
        }
        th:hover {
            background-color: #e5e7eb;
        }
        tr:hover {
            background-color: #f3f4f6;
        }
        tr.highlighted:hover {
            background-color: #fde047 !important;
        }
        tr.highlighted:hover td {
            background-color: #fde047 !important;
        }
        /* 固定表头 */
        thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f9fafb;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4">
    <div class="max-w-full mx-auto">
        <!-- 标题 -->
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">A股所有股票人均指标统计表</h1>
        
        <!-- 统计时间 -->
        <p id="statTime" class="text-center text-gray-600 mb-2 text-lg">统计时间：加载中...</p>
        
        <!-- 提示文字 -->
        <p class="text-center text-gray-400 text-sm mb-4">数据量大，计算、滚动和排序略有卡顿</p>
        
        <!-- 勾选框 -->
        <div class="flex justify-center mb-4">
            <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" id="sortByIndustry" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                <span class="text-gray-700">先按申万二级行业分类排序，再按照点击表头排序</span>
            </label>
        </div>
        
        <!-- 表格容器 -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="overflow-x-auto" style="max-height: 80vh;">
                <table id="stockTable" class="w-full text-sm">
                    <thead class="bg-gray-100 text-gray-700">
                        <tr>
                            <th data-field="code" class="sort-arrow px-3 py-2 text-left font-semibold border-b whitespace-nowrap">股票代码</th>
                            <th data-field="name" class="sort-arrow px-3 py-2 text-left font-semibold border-b whitespace-nowrap">股票名称</th>
                            <th data-field="market_cap" class="sort-arrow px-3 py-2 text-right font-semibold border-b whitespace-nowrap">总市值(亿)</th>
                            <th data-field="swii" id="swiiHeader" class="sort-arrow px-3 py-2 text-left font-semibold border-b whitespace-nowrap">申万二级分类</th>
                            <th data-field="n_employee" class="sort-arrow px-3 py-2 text-right font-semibold border-b whitespace-nowrap">员工人数</th>
                            <th data-field="pb_ratio" class="sort-arrow px-3 py-2 text-right font-semibold border-b whitespace-nowrap">PB</th>
                            <th data-field="pe_ratio" class="sort-arrow px-3 py-2 text-right font-semibold border-b whitespace-nowrap">PE</th>
                            <th data-field="ps_ratio" class="sort-arrow px-3 py-2 text-right font-semibold border-b whitespace-nowrap">PS</th>
                            <th data-field="roe" class="sort-arrow px-3 py-2 text-right font-semibold border-b whitespace-nowrap">ROE(%)</th>
                            <th data-field="pb_roe" class="sort-arrow px-3 py-2 text-right font-semibold border-b whitespace-nowrap">PB/ROE</th>
                            <th data-field="roe_pb" class="sort-arrow px-3 py-2 text-right font-semibold border-b whitespace-nowrap">ROE/PB(%)</th>
                            <th data-field="total_assets" class="sort-arrow px-3 py-2 text-right font-semibold border-b whitespace-nowrap">人均总资产(万)</th>
                            <th data-field="total_liability" class="sort-arrow px-3 py-2 text-right font-semibold border-b whitespace-nowrap">人均总债务(万)</th>
                            <th data-field="equities_parent_company_owners" class="sort-arrow px-3 py-2 text-right font-semibold border-b whitespace-nowrap">人均净资产(万)</th>
                            <th data-field="total_operating_revenue" class="sort-arrow px-3 py-2 text-right font-semibold border-b whitespace-nowrap">人均经营收入(万)</th>
                            <th data-field="account_receivable" class="sort-arrow px-3 py-2 text-right font-semibold border-b whitespace-nowrap">人均应收(万)</th>
                            <th data-field="np_parent_company_owners" class="sort-arrow px-3 py-2 text-right font-semibold border-b whitespace-nowrap">人均净利润(万)</th>
                            <th data-field="net_operate_cash_flow" class="sort-arrow px-3 py-2 text-right font-semibold border-b whitespace-nowrap">人均经营净现金流(万)</th>
                            <th data-field="inventories" class="sort-arrow px-3 py-2 text-right font-semibold border-b whitespace-nowrap">人均存货(万)</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-gray-200">
                        <!-- 数据将通过JS插入 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let stockData = [];
        let currentSortField = null;
        let currentSortDirection = 'desc';
        let precomputedSorts = {};

        // 加载JSON数据 - 使用XMLHttpRequest支持本地文件
        function loadData() {
            const xhr = new XMLHttpRequest();
            xhr.open('GET', 'No-015-res.json', true);
            xhr.responseType = 'text';
            
            xhr.onload = function() {
                if (xhr.status === 200 || xhr.status === 0) {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        processData(data);
                    } catch (e) {
                        console.error('JSON解析失败:', e);
                        document.getElementById('statTime').textContent = '数据解析失败: ' + e.message;
                    }
                } else {
                    document.getElementById('statTime').textContent = '数据加载失败: HTTP ' + xhr.status;
                }
            };
            
            xhr.onerror = function() {
                console.error('请求失败');
                document.getElementById('statTime').textContent = '数据加载失败: 无法读取文件';
            };
            
            xhr.send();
        }
        
        // 处理加载的数据
        function processData(data) {
            // 提取info信息
            const info = data.info;
            const date = new Date(info.end_dt);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            document.getElementById('statTime').textContent = `统计时间：${year}年${month}月${day}日`;
            
            // 处理股票数据
            stockData = [];
            for (const [code, stock] of Object.entries(data)) {
                if (code === 'info') continue;
                
                    // 计算 roe/pb，异常时赋值为0
                    let roe_pb = 0;
                    if (stock.pb_ratio && stock.pb_ratio !== 0 && 
                        typeof stock.roe === 'number' && !isNaN(stock.roe) &&
                        typeof stock.pb_ratio === 'number' && !isNaN(stock.pb_ratio) &&
                        isFinite(stock.roe) && isFinite(stock.pb_ratio)) {
                        roe_pb = stock.roe / stock.pb_ratio;
                    }
                    
                    stockData.push({
                    code: code,
                    name: stock.name,
                    market_cap: stock.market_cap,
                    market_name: stock.market_name,
                    swii: stock.swii,
                    n_employee: stock.n_employee,
                    pb_ratio: stock.pb_ratio,
                    pe_ratio: stock.pe_ratio,
                    ps_ratio: stock.ps_ratio,
                    roe: stock.roe,
                    pb_roe: stock.pb_roe * 100,
                    roe_pb: roe_pb,
                    total_assets: stock.total_assets,
                    total_liability: stock.total_liability,
                    equities_parent_company_owners: stock.equities_parent_company_owners,
                    account_receivable: stock.account_receivable,
                    inventories: stock.inventories,
                    total_operating_revenue: stock.total_operating_revenue,
                    np_parent_company_owners: stock.np_parent_company_owners,
                    net_operate_cash_flow: stock.net_operate_cash_flow
                });
            }
            
            // 预先计算所有排序
            precomputeSorts();
            
            // 默认显示（按股票代码排序）
            sortData('code', 'asc');
        }

        // 预先计算所有排序
        function precomputeSorts() {
            const fields = ['code', 'name', 'market_cap', 'swii', 'n_employee', 'pb_ratio', 
                          'pe_ratio', 'ps_ratio', 'roe', 'pb_roe', 'roe_pb', 'total_assets', 
                          'total_liability', 'equities_parent_company_owners', 
                          'total_operating_revenue', 'account_receivable', 
                          'np_parent_company_owners', 'net_operate_cash_flow', 'inventories'];
            
            fields.forEach(field => {
                precomputedSorts[`${field}_asc`] = sortAndCache(field, 'asc');
                precomputedSorts[`${field}_desc`] = sortAndCache(field, 'desc');
            });
        }

        // 排序并缓存
        function sortAndCache(field, direction) {
            const sorted = [...stockData].sort((a, b) => {
                let valA = a[field];
                let valB = b[field];
                
                // 处理字符串排序
                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }
                
                if (valA === null || valA === undefined) valA = direction === 'asc' ? Infinity : -Infinity;
                if (valB === null || valB === undefined) valB = direction === 'asc' ? Infinity : -Infinity;
                
                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
            return sorted;
        }

        // 获取排序后的数据
        function getSortedData(field, direction) {
            const sortByIndustry = document.getElementById('sortByIndustry').checked;
            
            if (!sortByIndustry) {
                // 不按行业排序，直接使用预计算的排序
                return precomputedSorts[`${field}_${direction}`];
            } else {
                // 先按申万二级行业分类排序，再按选定字段排序
                return sortByIndustryThenField(field, direction);
            }
        }

        // 先按申万二级行业分类排序，再按选定字段排序
        function sortByIndustryThenField(field, direction) {
            // 先按申万二级行业排序（升序）
            const sortedByIndustry = [...stockData].sort((a, b) => {
                const swiiA = a.swii || '';
                const swiiB = b.swii || '';
                return swiiA.localeCompare(swiiB);
            });
            
            // 按行业分组，每组内再按选定字段排序
            const grouped = {};
            sortedByIndustry.forEach(stock => {
                const swii = stock.swii || '未分类';
                if (!grouped[swii]) grouped[swii] = [];
                grouped[swii].push(stock);
            });
            
            // 对每个行业内的股票按选定字段排序
            Object.keys(grouped).forEach(swii => {
                grouped[swii].sort((a, b) => {
                    let valA = a[field];
                    let valB = b[field];
                    
                    if (typeof valA === 'string') {
                        valA = valA.toLowerCase();
                        valB = valB.toLowerCase();
                    }
                    
                    if (valA === null || valA === undefined) valA = direction === 'asc' ? Infinity : -Infinity;
                    if (valB === null || valB === undefined) valB = direction === 'asc' ? Infinity : -Infinity;
                    
                    if (valA < valB) return direction === 'asc' ? -1 : 1;
                    if (valA > valB) return direction === 'asc' ? 1 : -1;
                    return 0;
                });
            });
            
            // 合并结果
            const result = [];
            Object.keys(grouped).sort().forEach(swii => {
                result.push(...grouped[swii]);
            });
            
            return result;
        }

        // 格式化数字，保留两位小数
        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(num)) return '-';
            return num.toFixed(2);
        }

        // 格式化整数
        function formatInteger(num) {
            if (num === null || num === undefined || isNaN(num)) return '-';
            return Math.round(num).toLocaleString();
        }

        // 渲染表格
        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            const fragment = document.createDocumentFragment();
            
            data.forEach(stock => {
                const row = document.createElement('tr');
                row.className = 'transition-colors duration-150';
                row.tabIndex = 0;
                
                // 股票代码链接
                const xueqiuCode = stock.market_name + stock.code.split('.')[0];
                const codeLink = `https://xueqiu.com/S/${xueqiuCode}`;
                
                row.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap">
                        <a href="${codeLink}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline" onclick="event.stopPropagation();">
                            ${stock.code}
                        </a>
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap">${stock.name}</td>
                    <td class="px-3 py-2 text-right whitespace-nowrap">${formatNumber(stock.market_cap)}</td>
                    <td class="px-3 py-2 whitespace-nowrap">${stock.swii || '-'}</td>
                    <td class="px-3 py-2 text-right whitespace-nowrap">${formatInteger(stock.n_employee)}</td>
                    <td class="px-3 py-2 text-right whitespace-nowrap">${formatNumber(stock.pb_ratio)}</td>
                    <td class="px-3 py-2 text-right whitespace-nowrap">${formatNumber(stock.pe_ratio)}</td>
                    <td class="px-3 py-2 text-right whitespace-nowrap">${formatNumber(stock.ps_ratio)}</td>
                    <td class="px-3 py-2 text-right whitespace-nowrap">${formatNumber(stock.roe)}</td>
                    <td class="px-3 py-2 text-right whitespace-nowrap">${formatNumber(stock.pb_roe)}</td>
                    <td class="px-3 py-2 text-right whitespace-nowrap">${formatNumber(stock.roe_pb)}</td>
                    <td class="px-3 py-2 text-right whitespace-nowrap">${formatNumber(stock.total_assets)}</td>
                    <td class="px-3 py-2 text-right whitespace-nowrap">${formatNumber(stock.total_liability)}</td>
                    <td class="px-3 py-2 text-right whitespace-nowrap">${formatNumber(stock.equities_parent_company_owners)}</td>
                    <td class="px-3 py-2 text-right whitespace-nowrap">${formatNumber(stock.total_operating_revenue)}</td>
                    <td class="px-3 py-2 text-right whitespace-nowrap">${formatNumber(stock.account_receivable)}</td>
                    <td class="px-3 py-2 text-right whitespace-nowrap">${formatNumber(stock.np_parent_company_owners)}</td>
                    <td class="px-3 py-2 text-right whitespace-nowrap">${formatNumber(stock.net_operate_cash_flow)}</td>
                    <td class="px-3 py-2 text-right whitespace-nowrap">${formatNumber(stock.inventories)}</td>
                `;
                
                // 行选中高亮
                row.addEventListener('click', function() {
                    document.querySelectorAll('tr').forEach(r => r.classList.remove('highlighted'));
                    this.classList.add('highlighted');
                });
                
                // 失去焦点时取消高亮
                row.addEventListener('blur', function() {
                    this.classList.remove('highlighted');
                });
                
                fragment.appendChild(row);
            });
            
            tbody.appendChild(fragment);
        }

        // 排序数据
        function sortData(field, direction) {
            currentSortField = field;
            currentSortDirection = direction;
            
            const sortedData = getSortedData(field, direction);
            renderTable(sortedData);
            updateSortIndicators(field, direction);
        }

        // 更新排序指示器
        function updateSortIndicators(field, direction) {
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc', 'sort-arrow');
            });
            
            const activeTh = document.querySelector(`th[data-field="${field}"]`);
            if (activeTh) {
                activeTh.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc');
            }
        }

        // 初始化事件监听
        function initEventListeners() {
            // 表头点击排序
            document.querySelectorAll('th').forEach(th => {
                th.addEventListener('click', function() {
                    const field = this.getAttribute('data-field');
                    const sortByIndustry = document.getElementById('sortByIndustry').checked;
                    
                    // 如果勾选了按行业排序，且点击的是申万二级分类列，则不处理
                    if (sortByIndustry && field === 'swii') {
                        return;
                    }
                    
                    let direction = 'desc';
                    if (currentSortField === field) {
                        direction = currentSortDirection === 'desc' ? 'asc' : 'desc';
                    }
                    
                    sortData(field, direction);
                });
            });
            
            // 勾选框变化时重新排序
            document.getElementById('sortByIndustry').addEventListener('change', function() {
                const swiiHeader = document.getElementById('swiiHeader');
                if (this.checked) {
                    swiiHeader.classList.remove('sort-arrow', 'sort-asc', 'sort-desc');
                    swiiHeader.style.cursor = 'not-allowed';
                    swiiHeader.style.color = '#9ca3af';
                } else {
                    swiiHeader.classList.add('sort-arrow');
                    swiiHeader.style.cursor = 'pointer';
                    swiiHeader.style.color = '';
                }
                
                // 如果当前按swii排序，需要重新选择排序字段
                if (currentSortField === 'swii') {
                    sortData('code', 'asc');
                } else if (currentSortField) {
                    sortData(currentSortField, currentSortDirection);
                }
            });
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initEventListeners();
            loadData();
        });
    </script>
</body>
</html>
