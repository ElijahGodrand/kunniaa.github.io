<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A股所有股票最近12个月的月K线统计表</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            font-family: 'Inter', sans-serif;
        }

        .kline-char {
            font-family: monospace;
            font-weight: bold;
        }

        .selected-row {
            background-color: #3b82f6 !important;
            color: white !important;
        }

        .selected-row a {
            color: #dbeafe !important;
            font-weight: bold;
        }

        .selected-row .kline-char {
            color: white !important;
        }

        .sortable:hover {
            background-color: #f3f4f6;
            cursor: pointer;
        }

        /* 滚动条样式 */
        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-screen-2xl">
        <!-- 标题 -->
        <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-2">
            A股所有股票最近12个月的月K线统计表
        </h1>

        <!-- 统计时间 -->
        <div class="text-center text-gray-600 mb-1">
            <span id="stat-date" class="text-lg font-medium">统计时间：</span>
        </div>

        <!-- 提示信息 -->
        <p class="text-center text-sm text-gray-500 mb-8">
            数据量大，计算、滚动和排序略有卡顿
        </p>

        <!-- 控制面板 -->
        <div class="flex flex-wrap justify-between items-center mb-6 p-4 bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="mb-4 md:mb-0">
                <span class="text-gray-700 font-medium" id="stock-count">加载中...</span>
            </div>
            <div class="flex flex-wrap gap-3">
                <div class="relative">
                    <input type="text" id="search-input" placeholder="搜索股票代码或名称..."
                           class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full md:w-64">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
                <button id="reset-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                    <i class="fas fa-redo mr-2"></i>重置
                </button>
            </div>
        </div>

        <!-- 表格容器 -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
            <div class="table-container overflow-x-auto max-h-[70vh]">
                <table class="min-w-full divide-y divide-gray-200" id="stock-table">
                    <thead class="bg-gray-50 sticky top-0 z-10">
                        <tr id="table-header">
                            <!-- 表头将通过JavaScript动态生成 -->
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="table-body">
                        <!-- 表格内容将通过JavaScript动态生成 -->
                        <tr id="loading-row">
                            <td colspan="100" class="py-12 text-center">
                                <div class="flex justify-center">
                                    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
                                </div>
                                <p class="mt-4 text-gray-600">正在加载数据，请稍候...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 页脚说明 -->
        <!-- div class="mt-8 text-sm text-gray-500 text-center">
            <p>• 月K线使用Unicode字符表示：▁▂▃▄▅▆▇█（从低到高）</p>
            <p class="mt-1">• 点击表头可进行排序，再次点击可切换升序/降序</p>
            <p class="mt-1">• 点击股票代码可跳转到雪球查看详情</p>
            <p class="mt-1">• 点击行可高亮选中该股票</p>
        </div -->
    </div>

    <!-- 文件选择对话框 -->
    <input type="file" id="file-input" accept=".json" class="hidden">

    <script>
        // 应用程序状态
        const AppState = {
            data: null,
            stocks: [],
            sortColumn: null,
            sortDirection: 'desc', // 'asc' 或 'desc'
            selectedRow: null,
            searchTerm: '',
            klineChars: ['▁', '▂', '▃', '▄', '▅', '▆', '▇', '█'],
            precomputedSorts: {},
            loadTimeout: null
        };

        // DOM元素
        const DOM = {
            tableHeader: document.getElementById('table-header'),
            tableBody: document.getElementById('table-body'),
            loadingRow: document.getElementById('loading-row'),
            statDate: document.getElementById('stat-date'),
            stockCount: document.getElementById('stock-count'),
            searchInput: document.getElementById('search-input'),
            resetBtn: document.getElementById('reset-btn'),
            fileInput: document.getElementById('file-input')
        };

        // 初始化应用程序
        document.addEventListener('DOMContentLoaded', function() {
            initEventListeners();
            loadData();
        });

        // 初始化事件监听器
        function initEventListeners() {
            DOM.searchInput.addEventListener('input', function(e) {
                AppState.searchTerm = e.target.value.toLowerCase();
                renderTable();
            });

            DOM.resetBtn.addEventListener('click', function() {
                DOM.searchInput.value = '';
                AppState.searchTerm = '';
                AppState.sortColumn = null;
                AppState.sortDirection = 'desc';
                AppState.selectedRow = null;
                renderTable();
            });

            // 文件选择监听器（用于本地打开）
            DOM.fileInput.addEventListener('change', handleFileSelect);
        }

        // 检查是否为本地环境
        function isLocalFileSystem() {
            return window.location.protocol === 'file:';
        }

        // 清除加载超时
        function clearLoadTimeout() {
            if (AppState.loadTimeout) {
                clearTimeout(AppState.loadTimeout);
                AppState.loadTimeout = null;
            }
        }

        // 加载数据
        async function loadData() {
            if (isLocalFileSystem()) {
                // 本地环境：直接弹出文件选择对话框
                console.log('本地环境，弹出文件选择对话框');
                // 清除之前的超时
                clearLoadTimeout();
                // 使用setTimeout确保DOM完全加载后再触发
                setTimeout(() => {
                    showFileDialog();
                    // 设置检查超时：3秒后如果还没有数据，显示手动提示
                    AppState.loadTimeout = setTimeout(() => {
                        if (!AppState.data) {
                            console.warn('文件选择超时，显示手动提示');
                            showManualLoadPrompt();
                        }
                    }, 3000);
                }, 300);
            } else {
                // 网络环境：尝试从服务器加载
                try {
                    const response = await fetch('No-010-res.json');
                    if (response.ok) {
                        const jsonData = await response.json();
                        processData(jsonData);
                    } else {
                        console.warn('无法从服务器加载数据，请选择本地文件');
                        showFileDialog();
                    }
                } catch (error) {
                    console.warn('无法从服务器加载数据:', error);
                    showFileDialog();
                }
            }
        }

        // 显示文件选择对话框
        function showFileDialog() {
            try {
                // 方法1：使用现有的文件输入
                if (DOM.fileInput) {
                    DOM.fileInput.click();
                    return;
                }
            } catch (error) {
                console.warn('使用现有文件输入失败:', error);
            }

            // 方法2：创建临时文件输入
            try {
                const tempFileInput = document.createElement('input');
                tempFileInput.type = 'file';
                tempFileInput.accept = '.json';
                tempFileInput.style.display = 'none';

                // 添加事件监听器
                tempFileInput.addEventListener('change', function(e) {
                    handleFileSelect(e);
                    // 清理临时元素
                    document.body.removeChild(tempFileInput);
                });

                // 添加到body并触发点击
                document.body.appendChild(tempFileInput);
                tempFileInput.click();
            } catch (error) {
                console.error('创建临时文件输入失败:', error);
                // 方法3：显示手动加载提示
                showManualLoadPrompt();
            }
        }

        // 显示手动加载提示
        function showManualLoadPrompt() {
            // 隐藏加载指示器
            if (DOM.loadingRow) {
                DOM.loadingRow.style.display = 'none';
            }

            // 创建提示信息
            const promptDiv = document.createElement('div');
            promptDiv.id = 'manual-load-prompt';
            promptDiv.className = 'fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50';
            promptDiv.innerHTML = `
                <div class="bg-white rounded-xl p-8 max-w-md mx-4">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">加载数据文件</h3>
                    <p class="text-gray-600 mb-6">请手动选择数据文件以继续浏览。</p>
                    <div class="flex justify-center">
                        <button id="manual-load-btn" class="px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition">
                            选择 No-010-res.json 文件
                        </button>
                    </div>
                    <p class="mt-4 text-sm text-gray-500 text-center">文件应与本网页在同一目录下</p>
                </div>
            `;

            document.body.appendChild(promptDiv);

            // 添加手动加载按钮事件
            document.getElementById('manual-load-btn').addEventListener('click', function() {
                if (DOM.fileInput) {
                    DOM.fileInput.click();
                } else {
                    // 如果DOM.fileInput不存在，重新创建
                    const tempInput = document.createElement('input');
                    tempInput.type = 'file';
                    tempInput.accept = '.json';
                    tempInput.addEventListener('change', handleFileSelect);
                    tempInput.click();
                }
                // 移除提示
                document.body.removeChild(promptDiv);
            });
        }

        // 处理文件选择
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                // 用户取消了文件选择，显示手动提示
                console.log('用户取消了文件选择');
                showManualLoadPrompt();
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    processData(jsonData);
                } catch (error) {
                    alert('文件格式错误，请选择正确的JSON文件');
                    console.error('JSON解析错误:', error);
                    // 文件解析错误，也显示手动提示
                    showManualLoadPrompt();
                }
            };
            reader.readAsText(file);
        }

        // 处理数据
        function processData(jsonData) {
            // 清除加载超时
            clearLoadTimeout();

            // 移除手动加载提示（如果存在）
            const manualPrompt = document.getElementById('manual-load-prompt');
            if (manualPrompt) {
                document.body.removeChild(manualPrompt);
            }

            AppState.data = jsonData;

            // 更新统计时间
            const endDate = new Date(jsonData.info.end_dt);
            const formattedDate = `${endDate.getFullYear()}年${endDate.getMonth() + 1}月${endDate.getDate()}日`;
            DOM.statDate.textContent = `统计时间：${formattedDate}`;

            // 提取股票数据
            AppState.stocks = [];
            for (const [code, stockData] of Object.entries(jsonData)) {
                if (code === 'info') continue;

                AppState.stocks.push({
                    code: code,
                    name: stockData.name,
                    marketCap: stockData.market_cap,
                    marketName: stockData.market_name,
                    swii: stockData.swii,
                    monthK: stockData.month_k,
                    // 计算月K线字符
                    klineString: calculateKlineString(stockData.month_k)
                });
            }

            // 更新股票计数
            DOM.stockCount.textContent = `共 ${AppState.stocks.length} 支股票`;

            // 预计算排序数据
            precomputeSortData();

            // 渲染表格
            renderTable();

            // 隐藏加载指示器
            DOM.loadingRow.style.display = 'none';
        }

        // 计算月K线字符串
        function calculateKlineString(monthK) {
            if (!monthK || monthK.length === 0) return '';

            // 计算每个月的平均值
            const averages = monthK.map(k => (k[0] + k[1]) / 2);

            // 找到最小值和最大值
            const min = Math.min(...averages);
            const max = Math.max(...averages);
            const range = max - min;

            // 归一化到0-7并映射到字符
            return averages.map(avg => {
                if (range === 0) return AppState.klineChars[4]; // 中间值
                const normalized = Math.round(((avg - min) / range) * 7);
                return AppState.klineChars[Math.max(0, Math.min(7, normalized))];
            }).join('');
        }

        // 预计算排序数据
        function precomputeSortData() {
            // 为每个可排序列创建排序索引
            const stocks = AppState.stocks;
            const count = stocks.length;

            // 股票代码排序索引
            const codeIndices = Array.from({length: count}, (_, i) => i);
            codeIndices.sort((a, b) => stocks[a].code.localeCompare(stocks[b].code));
            AppState.precomputedSorts.code = {
                asc: [...codeIndices],
                desc: [...codeIndices].reverse()
            };

            // 股票名称排序索引
            const nameIndices = Array.from({length: count}, (_, i) => i);
            nameIndices.sort((a, b) => stocks[a].name.localeCompare(stocks[b].name));
            AppState.precomputedSorts.name = {
                asc: [...nameIndices],
                desc: [...nameIndices].reverse()
            };

            // 市值排序索引
            const marketCapIndices = Array.from({length: count}, (_, i) => i);
            marketCapIndices.sort((a, b) => stocks[a].marketCap - stocks[b].marketCap);
            AppState.precomputedSorts.marketCap = {
                asc: [...marketCapIndices],
                desc: [...marketCapIndices].reverse()
            };

            // 申万二级分类排序索引（特殊处理：先按行业，再按市值）
            const swiiIndices = Array.from({length: count}, (_, i) => i);
            swiiIndices.sort((a, b) => {
                if (stocks[a].swii === stocks[b].swii) {
                    return stocks[b].marketCap - stocks[a].marketCap; // 同行业内按市值降序
                }
                return stocks[a].swii.localeCompare(stocks[b].swii);
            });
            AppState.precomputedSorts.swii = {
                asc: [...swiiIndices],
                desc: [...swiiIndices].reverse()
            };
        }

        // 渲染表格
        function renderTable() {
            renderTableHeader();
            renderTableBody();
        }

        // 渲染表头
        function renderTableHeader() {
            // 清空表头
            DOM.tableHeader.innerHTML = '';

            // 表头配置
            const headers = [
                { id: 'code', label: '股票代码', sortable: true, width: 'w-32' },
                { id: 'name', label: '股票名称', sortable: true, width: 'w-40' },
                { id: 'marketCap', label: '总市值(亿)', sortable: true, width: 'w-32' },
                { id: 'swii', label: '申万二级分类', sortable: true, width: 'w-48' },
                { id: 'kline', label: '月K线走势', sortable: false, width: 'w-auto' }
            ];

            // 创建表头单元格
            headers.forEach(header => {
                const th = document.createElement('th');
                th.className = `px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider ${header.width} ${header.sortable ? 'sortable' : ''}`;
                th.setAttribute('data-column', header.id);

                // 添加内容
                const contentDiv = document.createElement('div');
                contentDiv.className = 'flex items-center justify-between';

                const span = document.createElement('span');
                span.textContent = header.label;
                contentDiv.appendChild(span);

                // 添加排序箭头
                if (header.sortable) {
                    const arrow = document.createElement('span');
                    arrow.className = 'ml-2 text-gray-400';
                    if (AppState.sortColumn === header.id) {
                        arrow.innerHTML = AppState.sortDirection === 'asc' ?
                            '<i class="fas fa-arrow-up"></i>' :
                            '<i class="fas fa-arrow-down"></i>';
                        arrow.classList.add('text-blue-500');
                    } else {
                        arrow.innerHTML = '<i class="fas fa-sort"></i>';
                    }
                    contentDiv.appendChild(arrow);

                    // 添加点击事件
                    th.addEventListener('click', () => handleSort(header.id));
                }

                th.appendChild(contentDiv);
                DOM.tableHeader.appendChild(th);
            });
        }

        // 处理排序
        function handleSort(column) {
            if (AppState.sortColumn === column) {
                // 切换排序方向
                AppState.sortDirection = AppState.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                // 新列排序
                AppState.sortColumn = column;
                AppState.sortDirection = 'desc';
            }

            renderTable();
        }

        // 渲染表格主体
        function renderTableBody() {
            // 清空表格主体
            DOM.tableBody.innerHTML = '';

            // 获取要显示的数据
            let displayStocks = [...AppState.stocks];

            // 应用搜索过滤
            if (AppState.searchTerm) {
                displayStocks = displayStocks.filter(stock =>
                    stock.code.toLowerCase().includes(AppState.searchTerm) ||
                    stock.name.toLowerCase().includes(AppState.searchTerm) ||
                    stock.swii.toLowerCase().includes(AppState.searchTerm)
                );
            }

            // 应用排序 - 使用预计算数据加速
            if (AppState.sortColumn && !AppState.searchTerm) {
                // 没有搜索过滤时使用预计算排序索引
                const sortData = AppState.precomputedSorts[AppState.sortColumn];
                if (sortData) {
                    const sortedIndices = AppState.sortDirection === 'asc' ? sortData.asc : sortData.desc;
                    // 根据预计算索引重新排列股票
                    displayStocks = sortedIndices.map(index => AppState.stocks[index]);
                }
            } else if (AppState.sortColumn) {
                // 有搜索过滤时使用实时排序
                displayStocks.sort((a, b) => {
                    let aValue, bValue;

                    if (AppState.sortColumn === 'swii') {
                        // 特殊处理：先按行业分类，再按市值
                        if (a.swii === b.swii) {
                            return b.marketCap - a.marketCap;
                        }
                        aValue = a.swii;
                        bValue = b.swii;
                    } else {
                        aValue = a[AppState.sortColumn];
                        bValue = b[AppState.sortColumn];
                    }

                    // 排序比较
                    if (typeof aValue === 'string') {
                        return AppState.sortDirection === 'asc' ?
                            aValue.localeCompare(bValue) :
                            bValue.localeCompare(aValue);
                    } else {
                        return AppState.sortDirection === 'asc' ?
                            aValue - bValue :
                            bValue - aValue;
                    }
                });
            }

            // 渲染每一行
            displayStocks.forEach((stock, rowIndex) => {
                const row = document.createElement('tr');
                row.className = `hover:bg-gray-50 ${rowIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50'} ${AppState.selectedRow === stock.code ? 'selected-row' : ''}`;
                row.setAttribute('data-code', stock.code);

                // 添加点击事件
                row.addEventListener('click', () => {
                    AppState.selectedRow = stock.code;
                    renderTable();
                });

                // 股票代码单元格
                const codeCell = document.createElement('td');
                codeCell.className = 'px-4 py-3 whitespace-nowrap text-sm font-medium';

                const marketPrefix = stock.marketName === 'SH' ? 'SH' : 'SZ';
                const xueqiuCode = stock.code.split('.')[0];
                const xueqiuUrl = `https://xueqiu.com/S/${marketPrefix}${xueqiuCode}`;

                const codeLink = document.createElement('a');
                codeLink.href = xueqiuUrl;
                codeLink.target = '_blank';
                codeLink.className = 'text-blue-600 hover:text-blue-800 hover:underline';
                codeLink.textContent = stock.code;
                codeCell.appendChild(codeLink);
                row.appendChild(codeCell);

                // 股票名称单元格
                const nameCell = document.createElement('td');
                nameCell.className = 'px-4 py-3 whitespace-nowrap text-sm text-gray-900';
                nameCell.textContent = stock.name;
                row.appendChild(nameCell);

                // 市值单元格
                const marketCapCell = document.createElement('td');
                marketCapCell.className = 'px-4 py-3 whitespace-nowrap text-sm text-gray-900 font-medium';
                marketCapCell.textContent = formatNumber(stock.marketCap);
                row.appendChild(marketCapCell);

                // 申万二级分类单元格
                const swiiCell = document.createElement('td');
                swiiCell.className = 'px-4 py-3 whitespace-nowrap text-sm text-gray-900';
                swiiCell.textContent = stock.swii;
                row.appendChild(swiiCell);

                // 月K线单元格
                const klineCell = document.createElement('td');
                klineCell.className = 'px-4 py-3 text-sm';

                const klineDiv = document.createElement('div');
                klineDiv.className = 'flex items-center space-x-1';

                // 添加每个K线字符
                for (let i = 0; i < stock.klineString.length; i++) {
                    const charSpan = document.createElement('span');
                    charSpan.className = 'kline-char text-sm';
                    charSpan.textContent = stock.klineString[i];
                    charSpan.title = `月份 ${i + 1}: ${stock.klineString[i]}`;
                    klineDiv.appendChild(charSpan);
                }

                klineCell.appendChild(klineDiv);
                row.appendChild(klineCell);

                DOM.tableBody.appendChild(row);
            });

            // 如果没有数据
            if (displayStocks.length === 0) {
                const emptyRow = document.createElement('tr');
                const emptyCell = document.createElement('td');
                emptyCell.colSpan = 5;
                emptyCell.className = 'px-4 py-8 text-center text-gray-500';
                emptyCell.textContent = AppState.searchTerm ? '未找到匹配的股票' : '暂无数据';
                emptyRow.appendChild(emptyCell);
                DOM.tableBody.appendChild(emptyRow);
            }
        }

        // 格式化数字（保留两位小数）
        function formatNumber(num) {
            if (typeof num !== 'number') return '0.00';
            return num.toFixed(2);
        }
    </script>
</body>
</html>