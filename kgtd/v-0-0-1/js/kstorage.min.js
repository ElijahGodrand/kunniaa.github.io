(async function(){window.KSTORAGE=window.KSTORAGE||{};KSTORAGE.supabaseUrl="https://xwfderywomeuhijnwire.supabase.co";KSTORAGE.supabaseKey="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh3ZmRlcnl3b21ldWhpam53aXJlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzMxNDcxOTMsImV4cCI6MjA0ODcyMzE5M30.O4NyBfuz2aJdPivtOx98ocK9PNn9lv85ZisC3Ybk9i8";KSTORAGE.supabaseClient=supabase.createClient(KSTORAGE.supabaseUrl,KSTORAGE.supabaseKey);KSTORAGE.bucketName="kgtd-storage";KSTORAGE.uploadDatabase=async function(b){try{const a=
KGTD.sqliteDB.export();console.log("dbBuffer");const c=new CompressionStream("gzip"),e=c.writable.getWriter();e.write(a);e.close();console.log("writer");const d=Date.now(),f=Math.floor(1E7+9E7*Math.random()).toString();b=`db-${d}-${f}.sqlite3.gz`;console.log("fileName = ",b);console.log("Attempting to upload to Supabase...");const {data:g,error:h}=await KSTORAGE.supabaseClient.storage.from(KSTORAGE.bucketName).upload(b,await (new Response(c.readable)).blob(),{upsert:!0,cacheControl:"3600"});console.log("Upload response:",
{data:g,error:h});if(h)throw console.error("Upload error details:",h),h;console.log("Getting public URL...");const {data:{publicUrl:k},error:l}=KSTORAGE.supabaseClient.storage.from(KSTORAGE.bucketName).getPublicUrl(b);if(l)throw console.error("URL error details:",l),l;console.log("publicUrl = ",k);return{id:f,url:k}}catch(a){throw console.error("Failed to upload database:",a),a;}};KSTORAGE.downloadDatabase=async function(b,a){try{console.log("id = ",b);const {data:c,error:e}=await KSTORAGE.supabaseClient.storage.from(KSTORAGE.bucketName).list();
console.log("files = ",c);if(e)throw e;const d=c.find(p=>p.name.includes(b));if(!d)throw Error("Database file not found");console.log("dbFile = ",d);const {data:f,error:g}=await KSTORAGE.supabaseClient.storage.from(KSTORAGE.bucketName).download(d.name);if(g)throw g;const h=new DecompressionStream("gzip"),k=h.writable.getWriter();k.write(await f.arrayBuffer());k.close();console.log("writer ok");const l=await (new Response(h.readable)).arrayBuffer(),m=new a.Database(new Uint8Array(l));console.log("newDb ok");
const q=m.exec("SELECT * FROM things");console.log("\u6240\u6709\u8bb0\u5f55:",q[0].values);const {error:n}=await KSTORAGE.supabaseClient.storage.from(KSTORAGE.bucketName).remove([d.name]);console.log("\u5220\u9664\u4e91\u7aef\u6587\u4ef6");n&&console.error("Failed to delete remote file:",n);console.log("newDb = ",m);return m}catch(c){throw console.error("Download error:",c),c;}};KSTORAGE.validateDatabase=function(b){try{return"ok"===b.exec("PRAGMA integrity_check")[0].values[0][0]}catch(a){return console.error("Database validation failed:",
a),!1}};KSTORAGE.shareDatabase=async function(){try{const {id:b}=await KSTORAGE.uploadDatabase(window.db),a=document.createElement("div");a.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center";a.style.zIndex="9999";const c=document.createElement("div");c.className="bg-white p-6 rounded-lg max-w-sm mx-auto";const e=document.createElement("h2");e.className="text-xl font-bold mb-4";e.textContent="\u5206\u4eabID";const d=document.createElement("div");d.className="text-2xl mb-4 p-2 bg-gray-100 rounded cursor-pointer";
d.textContent=b;const f=document.createElement("button");f.className="bg-blue-500 text-white px-4 py-2 rounded";f.textContent="\u5173\u95ed";c.appendChild(e);c.appendChild(d);c.appendChild(f);a.appendChild(c);document.body.appendChild(a);f.onclick=()=>document.body.removeChild(a);d.onclick=async()=>{try{await navigator.clipboard.writeText(b),d.classList.add("bg-green-100"),setTimeout(()=>d.classList.remove("bg-green-100"),200)}catch(g){console.error("\u590d\u5236\u5931\u8d25:",g)}};a.onclick=g=>{g.target===
a&&document.body.removeChild(a)}}catch(b){alert("\u5206\u4eab\u5931\u8d25: "+b.message)}};KSTORAGE.receiveDatabase=async function(){try{const a=prompt("\u8bf7\u8f93\u5165\u5206\u4eabID:");if(a){var b=await KSTORAGE.downloadDatabase(a,KSQLITE.SQL);if(KSTORAGE.validateDatabase(b)){const c=KGTD.sqliteDB;KGTD.sqliteDB=b;c&&c.close();await KSQLITE.writeSqliteDBtoIndexedDB();await KGTD.updateThingsData();await KGTD.updateAllThingsList();await KGTD.updateToBeCompletedThingsList();await KGTD.updateCompletedThingsList();
alert("\u6570\u636e\u5e93\u5df2\u66f4\u65b0")}else throw Error("\u6570\u636e\u5e93\u9a8c\u8bc1\u5931\u8d25");}}catch(a){alert("\u63a5\u6536\u5931\u8d25: "+a.message)}}})();
