(async function(){window.KGTD=window.KGTD||{};KGTD.convertLocalTimeToLocalTimeStringWithTimeZone=function(a){const c=a.getFullYear(),b=a.getMonth()+1,d=a.getDate(),e=a.getHours(),f=a.getMinutes(),g=a.getSeconds();var h=a.getTimezoneOffset();a=Math.floor(Math.abs(h)/60);h=Math.abs(h)%60;return`${c.toString().padStart(4,"0")}-${b.toString().padStart(2,"0")}-${d.toString().padStart(2,"0")}T${e.toString().padStart(2,"0")}:${f.toString().padStart(2,"0")}:${g.toString().padStart(2,"0")}${0<=a?"+":"-"}${a.toString().padStart(2,
"0")}:${h.toString().padStart(2,"0")}`};KGTD.convertLocalTimeStringWithTimeZoneToLocalTime=function(a){return new Date(a)};KGTD.saveAThing=async function(){var a=document.getElementById("input-content").value;document.getElementById("input-content").value="";if(0===a.length)alert("\u7a7a\u5185\u5bb9\u4e0d\u80fd\u4fdd\u5b58");else{var c=KGTD.sqliteDB.exec("SELECT LOWER(HEX(RANDOMBLOB(16))) || '-' || LOWER(HEX(RANDOMBLOB(4))) || '-' || LOWER(HEX(RANDOMBLOB(4))) || '-' || LOWER(HEX(RANDOMBLOB(4))) || '-' || LOWER(HEX(RANDOMBLOB(12)))")[0].values[0][0],
b=0;a.includes("\u6bcf")&&(b=1);a=`INSERT INTO things (id,content,local_created_at,is_recurring,is_completed,\
          local_completed_at) VALUES ('${c}','${a}','${KGTD.convertLocalTimeToLocalTimeStringWithTimeZone(new Date)}',${b},0,'')`;KGTD.sqliteDB.run(a);await KSQLITE.writeSqliteDBtoIndexedDB();document.getElementById("input-content").style.height=KGTD.originalHeightOfTextarea+"px";KGTD.updateThingsData();KGTD.updateToBeCompletedThingsList();KGTD.updateAllThingsList()}};KGTD.createThingsTable=function(){var a=!0;0===KGTD.sqliteDB.exec("SELECT name FROM sqlite_master WHERE type='table' AND name='things'").length&&
(a=!1);a||(KGTD.sqliteDB.exec("CREATE TABLE things (    id VARCHAR(36) PRIMARY KEY,    content TEXT NOT NULL CHECK(length(content) <= 1000),    local_created_at VARCHAR(25) NOT NULL,    is_recurring BOOLEAN DEFAULT 0,    is_completed BOOLEAN DEFAULT 0,    local_completed_at VARCHAR(25)    );"),KSQLITE.writeSqliteDBtoIndexedDB())};KGTD.updateThingsData=function(){KGTD.thingsData=[];const a=KGTD.sqliteDB.exec("SELECT * FROM things");for(let c=0;c<a[0].values.length;c++){let b={};for(let d=0;d<a[0].columns.length;d++)b[a[0].columns[d]]=
a[0].values[c][d];b._local_created_at=(new Date(b.local_created_at)).toLocaleString().replace(/\//g,"-");KGTD.thingsData.push(b)}};KGTD.updateAllThingsList=function(){const a=document.getElementById("all-things-list");a.innerHTML="";let c=KGTD.thingsData.sort((b,d)=>new Date(d.local_created_at)-new Date(b.local_created_at));for(let b=0;b<c.length;b++){const d=c[b];if(d.is_hidden)continue;const e=document.createElement("li");e.className="py-2 px-4 border-b border-gray-300";e.setAttribute("data-uuid",
d.id);let f=d.is_recurring?"fa-sync":"fa-circle",g="";g=d.is_completed?`
                    <div class="text-xs text-gray-400">\u521b\u5efa: ${d._local_created_at}</div>
                <div class="text-xs text-gray-400">\u5b8c\u6210: ${d._local_completed_at}</div>
                    `:`
                <div class="text-xs text-gray-400">\u521b\u5efa: ${d._local_created_at}</div>
                `;e.innerHTML=`
            <i class="fas text-orange-300 ${f} text-xs mr-2"></i>
            <span class="task-text">${d.content}</span>
            <input type="text" class="edit-input hidden" value="${d.content}" onblur="KGTD.saveEdit(this)" />
            
            </div>
            <div>
            <div class="text-xs text-gray-400">
                ${g}
            </div>`;a.appendChild(e)}};KGTD.addHiddenFieldToThingsTable=function(){let a=KGTD.sqliteDB.exec("PRAGMA table_info('things')")[0].values,c=!1;for(let b=0;b<a.length;b++)if("is_hidden"===a[b][1]){c=!0;break}c||(console.log("\u6dfb\u52a0\u4e86'\u662f\u5426\u9690\u85cf'\u5b57\u6bb5\u5230'things'\u8868"),KGTD.sqliteDB.run("ALTER TABLE things ADD COLUMN is_hidden INTEGER DEFAULT 0",function(){console.log("\u6dfb\u52a0\u4e86'\u662f\u5426\u9690\u85cf'\u5b57\u6bb5\u5230'things'\u8868")}),KSQLITE.writeSqliteDBtoIndexedDB(),
KGTD.updateThingsData())};KGTD.updateToBeCompletedThingsList=function(){const a=document.getElementById("to-be-completed-things-list");a.innerHTML="";let c=KGTD.thingsData.sort((b,d)=>new Date(d.local_created_at)-new Date(b.local_created_at));for(let b=0;b<c.length;b++){const d=c[b];if(d.is_completed)continue;const e=document.createElement("li");e.className="py-2 px-4 border-b border-gray-300";e.setAttribute("data-uuid",d.id);e.innerHTML=`
            <i class="fas text-orange-300 ${d.is_recurring?"fa-sync":"fa-circle"} text-xs mr-2"></i>
            <span class="task-text">${d.content}</span>
            <input type="text" class="edit-input hidden" value="${d.content}" onblur="KGTD.saveEdit(this)" />
            <div class="inline justify-end float-right space-x-1 ml-1">
                <button class="bg-green-400 text-white rounded px-1 text-xs"
                    onclick="KGTD.editTask(this)">\u4fee\u6539
                </button>
                <button class="bg-blue-400 text-white rounded px-1 text-xs"
                    onclick="KGTD.finishTask(this)">\u5b8c\u6210
                </button>
                <button class="bg-red-400 text-white rounded px-1 text-xs"
                    onclick="KGTD.deleteTask(this)">\u5220\u9664
                </button>
            </div>
            <div>
                <div class="text-xs text-gray-400">\u521b\u5efa: ${d._local_created_at}</div>
            </div>
        `;a.appendChild(e)}};KGTD.updateCompletedThingsList=function(){const a=document.getElementById("completed-things-list");a.innerHTML="";let c=KGTD.thingsData.sort((d,e)=>new Date(e.local_created_at)-new Date(d.local_created_at));for(let d=0;d<c.length;d++){const e=c[d];if(e.is_completed&&!e.is_hidden){var b=new Date(e.local_completed_at);e._local_completed_at=b.getFullYear()+"-"+(b.getMonth()+1).toString().padStart(2,"0")+"-"+b.getDate().toString().padStart(2,"0")+" "+b.getHours().toString().padStart(2,
"0")+":"+b.getMinutes().toString().padStart(2,"0")+":"+b.getSeconds().toString().padStart(2,"0");b=document.createElement("li");b.className="py-2 px-4 border-b border-gray-300";b.setAttribute("data-uuid",e.id);b.innerHTML=`
            <i class="fas text-orange-300 ${e.is_recurring?"fa-sync":"fa-circle"} text-xs mr-2"></i>
            <span class="task-text">${e.content}</span>
            <input type="text" class="edit-input hidden" value="${e.content}" onblur="KGTD.saveEdit(this)" />
            <div class="inline justify-end float-right space-x-1 ml-1">                
                <button class="bg-purple-400 text-white rounded px-1 text-xs"
                    onclick="KGTD.hideTask(this)">\u9690\u85cf
                </button>
                <button class="bg-red-400 text-white rounded px-1 text-xs"
                    onclick="KGTD.deleteTask(this)">\u5220\u9664
                </button>
            </div>
            <div>
                <div class="text-xs text-gray-400">\u521b\u5efa: ${e._local_created_at}</div>
                <div class="text-xs text-gray-400">\u5b8c\u6210: ${e._local_completed_at}</div>
            </div>
        `;a.appendChild(b)}}};KGTD.expandAndShrinkDisplay=function(a){var c=a.parentNode.querySelector(".elem-can-hidden");c.classList.contains("hidden")?(c.classList.remove("hidden"),c.classList.add("max-h-md"),c.classList.remove("max-h-0"),c.classList.remove("overflow-hidden")):(c.classList.add("hidden"),c.classList.remove("max-h-md"),c.classList.add("max-h-0"),c.classList.add("overflow-hidden"));a=a.parentNode.querySelector(".ico-of-change-state");a.classList.contains("fa-plus")?(a.classList.remove("fa-plus"),
a.classList.add("fa-minus")):(a.classList.remove("fa-minus"),a.classList.add("fa-plus"))};KGTD.editTask=function(a){var c=a.closest("li");a=c.querySelector(".task-text");c=c.querySelector(".edit-input");a.classList.toggle("hidden");c.classList.toggle("hidden");c.focus()};KGTD.saveEdit=function(a){console.log("===================");console.log("kgtd.saveedit");var c=a.closest("li");const b=c.querySelector(".task-text");b.textContent=a.value;b.classList.remove("hidden");a.classList.add("hidden");c=
c.getAttribute("data-uuid");a=a.value;console.log("uuid = ",c);console.log("content = ",a);KGTD.sqliteDB.run("UPDATE things SET content = ? WHERE id = ?",[a,c],function(){});KSQLITE.writeSqliteDBtoIndexedDB();KGTD.updateThingsData();KGTD.updateToBeCompletedThingsList();KGTD.updateAllThingsList()};KGTD.deleteTask=function(a){(a=a.closest("li").getAttribute("data-uuid"))&&KGTD.sqliteDB.run("DELETE FROM things WHERE id = ?",[a],function(){});KSQLITE.writeSqliteDBtoIndexedDB();KGTD.updateThingsData();
KGTD.updateToBeCompletedThingsList();KGTD.updateCompletedThingsList();KGTD.updateAllThingsList()};KGTD.finishTask=function(a){if(a=a.closest("li").getAttribute("data-uuid")){const c=KGTD.convertLocalTimeToLocalTimeStringWithTimeZone(new Date);KGTD.sqliteDB.run("UPDATE things SET is_completed = 1, local_completed_at = ? WHERE id = ?",[c,a],function(){})}KSQLITE.writeSqliteDBtoIndexedDB();KGTD.updateThingsData();KGTD.updateToBeCompletedThingsList();KGTD.updateCompletedThingsList();KGTD.updateAllThingsList()};
KGTD.hideTask=function(a){(a=a.closest("li").getAttribute("data-uuid"))&&KGTD.sqliteDB.run("UPDATE things SET is_hidden = 1 WHERE id = ?",[a],function(){});KSQLITE.writeSqliteDBtoIndexedDB();KGTD.updateThingsData();KGTD.updateCompletedThingsList();KGTD.updateAllThingsList()};KGTD.exportDatabase=async function(){try{const a=KGTD.sqliteDB.export(),c=new Blob([a],{type:"application/x-sqlite3"}),b=new Date,d=`kgtd-${b.getFullYear()+String(b.getMonth()+1).padStart(2,"0")+String(b.getDate()).padStart(2,
"0")}.db`,e=window.URL.createObjectURL(c),f=document.createElement("a");f.href=e;f.download=d;f.click();window.URL.revokeObjectURL(e)}catch(a){console.error("\u5bfc\u51fa\u6570\u636e\u5e93\u65f6\u53d1\u751f\u9519\u8bef:",a),alert("\u5bfc\u51fa\u6570\u636e\u5e93\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5")}};KGTD.exportDatabaseToCSV=async function(){try{const g=KGTD.sqliteDB.exec("SELECT * FROM things");if(g&&0!==g.length){var a=g[0].columns.join(",")+"\n";g[0].values.forEach(h=>{h=h.map(k=>{if(null===k)return"";
k=String(k);return k.includes(",")||k.includes('"')||k.includes("\n")?`"${k.replace(/"/g,'""')}"`:k});a+=h.join(",")+"\n"});var c=new Blob([a],{type:"text/csv;charset=utf-8;"}),b=new Date,d=`kgtd-${b.getFullYear()+String(b.getMonth()+1).padStart(2,"0")+String(b.getDate()).padStart(2,"0")}.csv`,e=window.URL.createObjectURL(c),f=document.createElement("a");f.href=e;f.download=d;f.click();window.URL.revokeObjectURL(e)}else alert("\u6ca1\u6709\u6570\u636e\u53ef\u4ee5\u5bfc\u51fa")}catch(g){console.error("\u5bfc\u51faCSV\u6587\u4ef6\u65f6\u53d1\u751f\u9519\u8bef:",
g),alert("\u5bfc\u51faCSV\u6587\u4ef6\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5")}};KGTD.sqliteDB=await KSQLITE.createSqliteDB();KGTD.createThingsTable();KGTD.addHiddenFieldToThingsTable();KGTD.thingsData=void 0;"complete"===document.readyState?(KGTD.updateThingsData(),KGTD.updateToBeCompletedThingsList(),KGTD.updateCompletedThingsList(),KGTD.updateAllThingsList()):document.addEventListener("DOMContentLoaded",function(){KGTD.updateThingsData();KGTD.updateToBeCompletedThingsList();KGTD.updateCompletedThingsList();
KGTD.updateALLThingsList()});const l=document.getElementById("input-content");KGTD.originalHeightOfTextarea=document.getElementById("input-content").offsetHeight;l.addEventListener("input",()=>{l.style.height="auto";l.style.height=l.scrollHeight+"px"})})();
