(function(){window.KVR=window.KVR||{};KVR.audio=document.getElementById("audioPlayer");KVR.currentAudioName="";KVR.isInRPState=!1;KVR.importMenu=document.getElementById("importMenu");KVR.importSubMenu=document.getElementById("importSubMenu");KVR.exportMenu=document.getElementById("exportMenu");KVR.exportSubMenu=document.getElementById("exportSubMenu");KVR.debugMenu=document.getElementById("debugMenu");KVR.debugSubMenu=document.getElementById("debugSubMenu");KVR.helpMenu=document.getElementById("helpMenu");
KVR.helpSubMenu=document.getElementById("helpSubMenu");KVR.intervalID=null;KVR.rpTimePointStart=-1;KVR.rpTimePointEnd=-1;KVR.LANGUAGETOGGL=document.getElementById("languageToggle");KVR.isEnglish=!0;KVR.TRANSLATIONS={Import:"\u5bfc\u5165","Import an audio file":"\u5bfc\u5165\u4e00\u4e2a\u97f3\u9891\u6587\u4ef6",Export:"\u5bfc\u51fa","Export a repeating record file":"\u5bfc\u51fa\u4e00\u4e2a\u590d\u8bfb\u8bb0\u5f55\u6587\u4ef6",Debug:"\u8c03\u8bd5","Console: read all keys":"\u63a7\u5236\u53f0\uff1a\u8bfb\u53d6\u6570\u636e\u5e93\u6240\u6709\u7684Keys",
"Console: delete audio database":"\u63a7\u5236\u53f0\uff1a\u5220\u9664\u97f3\u9891\u6570\u636e\u5e93","Update play list":"\u66f4\u65b0\u64ad\u653e\u5217\u8868",Help:"\u5e2e\u52a9",Tutorial:"\u6559\u7a0b","Continue play":"\u7ee7\u7eed\u64ad\u653e","Repeating start":"\u590d\u8bfb\u8d77\u70b9","Repeating end":"\u590d\u8bfb\u7ec8\u70b9","Add repeating":"\u6dfb\u52a0\u590d\u8bfb","Reset play":"\u91cd\u7f6e\u64ad\u653e","Audio library":"\u97f3\u9891\u5e93","Repeating list":"\u590d\u8bfb\u5217\u8868",Delete:"\u5220\u9664",
"All Rights Reserved":"\u4fdd\u7559\u6240\u6709\u6743\u5229","Kunniaa Voice Repeater":"\u8363\u8000\u8bed\u97f3\u590d\u8bfb\u673a",Version:"\u7248\u672c",Update:"\u66f4\u65b0","Kunniaa Design":"\u8363\u8000\u8bbe\u8ba1","Import an repeating point file":"\u5bfc\u5165\u4e00\u4e2a\u590d\u8bfb\u4fe1\u606f\u6587\u4ef6","Export an audio file":"\u5bfc\u51fa\u4e00\u4e2a\u97f3\u9891\u6587\u4ef6","Export all files":"\u5bfc\u51fa\u6240\u6709\u6587\u4ef6","Import an zip file of audio and rp":"\u5bfc\u5165\u5305\u542b\u97f3\u9891\u548c\u590d\u8bfb\u4fe1\u606f\u7684Zip\u6587\u4ef6",
Tools:"\u5de5\u5177","LAN data synchronization":"\u5c40\u57df\u7f51\u6570\u636e\u540c\u6b65"};KVR.LANGUAGETOGGL.addEventListener("click",function(){KVR.isEnglish=!KVR.isEnglish;KVR.LANGUAGETOGGL.textContent=KVR.isEnglish?"\u4e2d\u6587":"EN";document.querySelectorAll("[data-translate]").forEach(a=>{const b=a.getAttribute("data-translate");a.textContent=KVR.isEnglish?b:KVR.TRANSLATIONS[b]});setTimeout(function(){KVR.setBottomSutiableSize()},1E3)});KVR.audio.addEventListener("play",()=>{KVR.setButtonState("btnCntPlay",
!1);KVR.setButtonState("btnRPSart",!0);KVR.setButtonState("btnRPEnd",!1);KVR.setButtonState("btnRPAdd",!1);KVR.setButtonState("btnReset",!1)});KVR.audio.addEventListener("ended",()=>{KVR.setButtonState("btnCntPlay",!0);KVR.setButtonState("btnRPSart",!1);KVR.setButtonState("btnRPEnd",!1);KVR.setButtonState("btnRPAdd",!1);KVR.setButtonState("btnReset",!1)});KVR.audio.addEventListener("pause",()=>{KVR.setButtonState("btnCntPlay",!0);KVR.setButtonState("btnRPSart",!1);KVR.setButtonState("btnRPEnd",!1);
KVR.setButtonState("btnRPAdd",!1);KVR.setButtonState("btnReset",!1)});KVR.audio.addEventListener("mousedown",function(a){KVR.isInRPState&&(a.preventDefault(),a.stopPropagation())},!0);KVR.audio.addEventListener("click",function(a){KVR.isInRPState&&(a.preventDefault(),a.stopPropagation())},!0);document.addEventListener("keydown",a=>{a=a.key;"ArrowLeft"==a?--KVR.audio.currentTime:"ArrowRight"==a&&(KVR.audio.currentTime+=1)},!1);KVR.importMenu.addEventListener("mouseenter",()=>{KVR.importSubMenu.classList.remove("hidden")});
KVR.importMenu.addEventListener("mouseleave",a=>{"importSubMenu"!=a.target.id&&KVR.importSubMenu.classList.add("hidden")});KVR.importSubMenu.addEventListener("mouseleave",()=>{KVR.importSubMenu.classList.add("hidden")});KVR.importSubMenu.addEventListener("click",()=>{KVR.importSubMenu.classList.add("hidden")});KVR.exportMenu.addEventListener("mouseenter",()=>{KVR.exportSubMenu.classList.remove("hidden")});KVR.exportMenu.addEventListener("mouseleave",a=>{"exportSubMenu"!=a.target.id&&KVR.exportSubMenu.classList.add("hidden")});
KVR.exportSubMenu.addEventListener("mouseleave",()=>{KVR.exportSubMenu.classList.add("hidden")});KVR.exportSubMenu.addEventListener("click",()=>{KVR.exportSubMenu.classList.add("hidden")});KVR.debugMenu.addEventListener("mouseenter",()=>{KVR.debugSubMenu.classList.remove("hidden")});KVR.debugMenu.addEventListener("mouseleave",a=>{"debugSubMenu"!=a.target.id&&KVR.debugSubMenu.classList.add("hidden")});KVR.debugSubMenu.addEventListener("mouseleave",()=>{KVR.debugSubMenu.classList.add("hidden")});KVR.helpMenu.addEventListener("mouseenter",
()=>{KVR.helpSubMenu.classList.remove("hidden")});KVR.helpMenu.addEventListener("mouseleave",a=>{"debugSubMenu"!=a.target.id&&KVR.helpSubMenu.classList.add("hidden")});KVR.helpSubMenu.addEventListener("mouseleave",()=>{KVR.helpSubMenu.classList.add("hidden")});KVR.helpSubMenu.addEventListener("click",()=>{KVR.helpSubMenu.classList.add("hidden")});KVR.WAVESURFER=WaveSurfer.create({container:document.getElementById("waveSurfer"),waveColor:"rgb(200, 0, 200)",progressColor:"rgb(100, 0, 100)",normalize:!0,
height:75,media:KVR.audio,minPxPerSec:10,hideScrollbar:!0});KVR.WAVESURFER.on("ready",function(){document.getElementById("placeholderWaveform").style.display="none"});document.getElementById("fileInput").addEventListener("change",async a=>{if(a=a.target.files[0])await KVR.storeAudioFile(a.name,a),KVR.updatePlayList(),KVR.setBottomSutiableSize()});window.addEventListener("resize",setBottomSutiableSize);KVR.setBottomSutiableSize=function(){const a=document.getElementById("footerInfo").offsetHeight,
b=document.getElementById("twoLists");b.classList.remove(...Array.from(b.classList).filter(c=>c.startsWith("mb-")));b.style.marginBottom=`${a+15}px`};KVR.storeAudioFile=async function(a,b){await KDB.checkKeyExists(a)?console.log(`'${a}'\u5df2\u7ecf\u5b58\u5728\u4e8e\u6570\u636e\u5e93\u4e2d\uff0c\u4e0d\u518d\u91cd\u590d\u5b58\u50a8`):(b=await b.arrayBuffer(),await KDB.storeData(a,b),console.log(`'${a}'\u5df2\u7ecf\u6210\u529f\u5b58\u5230\u6570\u636e\u5e93`))};KVR.storeList=async function(a,b){await KDB.checkKeyExists(a)?
console.log(`'${a}'\u5df2\u7ecf\u5b58\u5728\u4e8e\u6570\u636e\u5e93\u4e2d\uff0c\u4e0d\u518d\u91cd\u590d\u5b58\u50a8`):(await KDB.storeData(a,b),console.log(`'${a}'\u5df2\u7ecf\u6210\u529f\u5b58\u5230\u6570\u636e\u5e93`))};KVR.exportAllFiles=async function(){const a=document.createElement("div");a.className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50";a.style.zIndex="9999";var b=document.createElement("div");b.className="w-1/2 bg-gray-200 rounded-full h-5 overflow-hidden";
b.innerHTML='<div class="h-full bg-blue-500 transition-all duration-300 ease-out" style="width: 0%;" id="progressBarFill"></div>';a.appendChild(b);document.body.appendChild(a);b=g=>{document.getElementById("progressBarFill").style.width=`${g}%`};try{const g=await KDB.db[KDB.objectStorName].toArray();if(!(0>=g.length)){var c=new JSZip,d=g.length,e=0;for(const l of g){e+=1;if(l.key.endsWith(".rp")){let n=l.value.map(m=>String(m[0])+","+String(m[1])).reduce((m,q)=>m+"\n"+q)+"\n";c.file(l.key+".txt",
n)}else(l.key.endsWith(".mp3")||l.key.endsWith(".egg")||l.key.endsWith(".wav"))&&c.file(l.key,l.value);await new Promise(n=>setTimeout(n,50));b(1*e/d*100)}document.body.removeChild(a);var f=await c.generateAsync({type:"blob"}),h=URL.createObjectURL(f),k=document.createElement("a");k.href=h;k.download="kvr-all-files.zip";document.body.appendChild(k);k.click();document.body.removeChild(k);URL.revokeObjectURL(h);console.log("\u6587\u4ef6\u5bfc\u51fa\u6210\u529f")}}catch(g){console.error("\u5bfc\u51fa\u6587\u4ef6\u65f6\u51fa\u9519:",
g)}};KVR.exportAudioFile=function(){let a=document.createElement("div");a.className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center";a.style.zIndex=9999;a.innerHTML='\n        <div class="bg-white p-5 rounded-lg shadow-xl w-96">\n            <span class="text-lg font-bold mb-4">\u9009\u62e9\u8981\u5bfc\u51fa\u7684\u97f3\u9891</span>\n            <div id="rpAudioFileList" class="mb-4 max-h-60 overflow-y-auto"></div>\n            <div class="flex justify-end">\n                <button id="cancelExport" class="mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">\u53d6\u6d88</button>\n                <button id="confirmExport" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">\u5bfc\u51fa</button>\n            </div>\n        </div>\n    ';
document.body.appendChild(a);KDB.db[KDB.objectStorName].where("key").startsWith("").keys().then(b=>{let c=document.getElementById("rpAudioFileList");b.forEach(d=>{if(d.endsWith(".mp3")||d.endsWith(".egg")||d.endsWith(".wav")){let e=document.createElement("div");e.innerHTML=`
                <label class="flex items-center">
                    <input type="radio" name="rpFile" value="${d}" class="mr-2">
                    ${d}
                </label>
            `;c.appendChild(e)}})}).catch(b=>{console.error("\u83b7\u53d6audio\u6587\u4ef6\u5217\u8868\u5931\u8d25\uff1a",b)});document.getElementById("confirmExport").addEventListener("click",()=>{let b=document.querySelector('input[name="rpFile"]:checked');b?KDB.db.table(KDB.objectStorName).get(b.value).then(c=>{var d=null;b.value.endsWith(".mp3")?d=new Blob([c.value],{type:"audio/mpeg"}):b.value.endsWith(".egg")?d=new Blob([c.value],{type:"audio/egg"}):b.value.endsWith(".wav")?d=new Blob([c.value],
{type:"audio/wav"}):console.error("\u4e0d\u652f\u6301\u7684\u6587\u4ef6\u683c\u5f0f\uff1a",b.value);c=URL.createObjectURL(d);d=document.createElement("a");d.href=c;d.download=`${b.value}`;d.click();URL.revokeObjectURL(c);a.remove()}).catch(c=>{a.remove();console.error("\u5bfc\u51fa\u6587\u4ef6\u5931\u8d25\uff1a",c)}):(a.remove(),alert("Please select a file to export"))});document.getElementById("cancelExport").addEventListener("click",()=>{a.remove()})};KVR.exportRPFile=function(){let a=document.createElement("div");
a.className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center";a.style.zIndex=9999;a.innerHTML='\n        <div class="bg-white p-5 rounded-lg shadow-xl w-96">\n            <span class="text-lg font-bold mb-4">\u9009\u62e9\u8981\u5bfc\u51fa\u7684\u590d\u8bfb\u8bb0\u5f55</span>\n            <span class="text-xs mb-4">(\u672a\u5217\u51fa\u97f3\u9891\u65e0\u590d\u8bfb\u8bb0\u5f55)</span>\n            <div id="rpFileList" class="mb-4 max-h-60 overflow-y-auto"></div>\n            <div class="flex justify-end">\n                <button id="cancelExport" class="mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">\u53d6\u6d88</button>\n                <button id="confirmExport" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">\u5bfc\u51fa</button>\n            </div>\n        </div>\n    ';
document.body.appendChild(a);KDB.db[KDB.objectStorName].where("key").startsWith("").keys().then(b=>{let c=document.getElementById("rpFileList");b.forEach(d=>{if(d.endsWith(".rp")){let e=document.createElement("div");e.innerHTML=`
                <label class="flex items-center">
                    <input type="radio" name="rpFile" value="${d}" class="mr-2">
                    ${d}
                </label>
            `;c.appendChild(e)}})}).catch(b=>{a.remove();console.error("\u83b7\u53d6.rp\u6587\u4ef6\u5217\u8868\u5931\u8d25\uff1a",b)});document.getElementById("confirmExport").addEventListener("click",()=>{let b=document.querySelector('input[name="rpFile"]:checked');b?KDB.db.table(KDB.objectStorName).get(b.value).then(c=>{c=c.value.map(e=>String(e[0])+","+String(e[1])).reduce((e,f)=>e+"\n"+f)+"\n";c=new Blob([c],{type:"text/plain"});c=URL.createObjectURL(c);let d=document.createElement("a");d.href=
c;d.download=`${b.value}.txt`;d.click();URL.revokeObjectURL(c);a.remove()}).catch(c=>{a.remove();console.error("\u5bfc\u51fa\u6587\u4ef6\u5931\u8d25\uff1a",c)}):alert("Please select a file to export")});document.getElementById("cancelExport").addEventListener("click",()=>{a.remove()})};KVR.disableAudioControl=function(){KVR.isInRPState=!0;KVR.audio.classList.add("pointer-events-none")};KVR.enableAudioControl=function(){KVR.isInRPState=!1;KVR.audio.classList.remove("pointer-events-none")};KVR.setButtonState=
function(a,b){a=document.getElementById(`${a}`);a.disabled=!b;a.classList.toggle("opacity-50",!b);a.classList.toggle("cursor-not-allowed",!b)};KVR.setButtonRPColor=function(a,b){a=document.getElementById(`${a}`);b?(a.classList.remove("bg-blue-500"),a.classList.add("bg-green-500")):(a.classList.remove("bg-green-500"),a.classList.add("bg-blue-500"))};KVR.cntPlayAudio=function(a){0==KVR.audio.readyState?alert("Please load an audio first"):a.disabled||(null!=KVR.intervalID&&(window.clearInterval(KVR.intervalID),
KVR.intervalID=null,KVR.rpTimePointStart=-1,KVR.rpTimePointEnd=-1),KVR.isInRPState&&KVR.enableAudioControl(),KVR.audio.play(),KVR.setButtonState("btnCntPlay",!1),KVR.setButtonState("btnRPSart",!0),KVR.setButtonState("btnRPEnd",!1),KVR.setButtonState("btnRPAdd",!1),KVR.setButtonState("btnReset",!1),KVR.setButtonRPColor("btnRPSart",!1),KVR.setButtonRPColor("btnRPEnd",!1))};KVR.recordRPStart=function(a){0==KVR.audio.readyState?alert("Please load an audio first"):a.disabled||(KVR.rpTimePointStart=KVR.audio.currentTime,
KVR.disableAudioControl(),KVR.setButtonState("btnCntPlay",!1),KVR.setButtonState("btnRPSart",!1),KVR.setButtonState("btnRPEnd",!0),KVR.setButtonState("btnRPAdd",!1),KVR.setButtonState("btnReset",!0),KVR.setButtonRPColor("btnRPSart",!0),KVR.setButtonRPColor("btnRPEnd",!1))};KVR.recordRPEnd=function(a){0==KVR.audio.readyState?alert("Please load an audio first"):a.disabled||(KVR.rpTimePointEnd=KVR.audio.currentTime,KVR.rpTimePointEnd<KVR.rpTimePointStart?alert("The repeating end time point is less than the repeating start time point, which is invalid. Please reselect the repeating end time point."):
(KVR.rpTimePointEnd=KVR.audio.currentTime,KVR.audio.currentTime=KVR.rpTimePointStart,KVR.audio.play(),KVR.intervalID=window.setInterval(function(){KVR.audio.currentTime>=KVR.rpTimePointEnd?KVR.audio.currentTime=KVR.rpTimePointStart:KVR.audio.currentTime<=KVR.rpTimePointStart&&(KVR.audio.currentTime=KVR.rpTimePointStart)},0),KVR.setButtonState("btnCntPlay",!1),KVR.setButtonState("btnRPSart",!1),KVR.setButtonState("btnRPEnd",!1),KVR.setButtonState("btnRPAdd",!0),KVR.setButtonState("btnReset",!0),KVR.setButtonRPColor("btnRPSart",
!0),KVR.setButtonRPColor("btnRPEnd",!0)))};KVR.updateOrAddToIndexedDB=async function(a,b){let c=a+".rp",d=await KDB.getData(c);null!=d?Array.isArray(d)?(d.push(b),d.sort((e,f)=>e[0]-f[0]),await KDB.storeData(c,d),KVR.updateRpList(a),KVR.setBottomSutiableSize(),console.log("\u5b58\u6570\u636e\u6210\u529f:",d)):console.log("\u83b7\u53d6\u5230\u5176\u4ed6\u7c7b\u578b\u7684\u6570\u636e:",d):(await KVR.storeList(c,[b]),console.log("\u5b58\u65b0\u6570\u636e\u6210\u529f:"),KVR.updateRpList(a),KVR.setBottomSutiableSize())};
KVR.addRP=function(a){0==KVR.audio.readyState?alert("Please load an audio first"):a.disabled||(a=[KVR.rpTimePointStart,KVR.rpTimePointEnd],console.log("\u590d\u8bfb\u65f6\u95f4\u70b9\uff1a"+KVR.rpTimePointStart+","+KVR.rpTimePointEnd),KVR.updateOrAddToIndexedDB(KVR.currentAudioName,a),KVR.setButtonState("btnCntPlay",!0),KVR.setButtonState("btnRPSart",!1),KVR.setButtonState("btnRPEnd",!1),KVR.setButtonState("btnRPAdd",!1),KVR.setButtonState("btnReset",!1),KVR.setButtonRPColor("btnRPSart",!0),KVR.setButtonRPColor("btnRPEnd",
!0))};KVR.resetAudioPlay=function(a){0==KVR.audio.readyState?alert("Please load an audio first"):a.disabled||(null!=KVR.intervalID&&(window.clearInterval(KVR.intervalID),KVR.intervalID=null),document.getElementById("rpList").querySelectorAll("li").forEach(b=>b.classList.remove("bg-green-200","text-green-800")),KVR.enableAudioControl(),0<KVR.rpTimePointEnd&&(KVR.audio.currentTime=KVR.rpTimePointEnd),KVR.audio.play(),KVR.rpTimePointStart=-1,KVR.rpTimePointEnd=-1,KVR.setButtonState("btnCntPlay",!1),
KVR.setButtonState("btnRPSart",!0),KVR.setButtonState("btnRPEnd",!1),KVR.setButtonState("btnRPAdd",!1),KVR.setButtonState("btnReset",!1),KVR.setButtonRPColor("btnRPSart",!1),KVR.setButtonRPColor("btnRPEnd",!1))};KVR.importRPFromFileToDatabase=function(){const a=document.createElement("input");a.type="file";a.accept=".txt";a.onchange=async function(b){b=b.target.files[0];if(b.name.endsWith(".rp.txt")){var c=b.name.slice(0,-4);try{if(await KDB.getData(c))alert("The same record already exists in the database and will not be imported");
else{var d=new FileReader;d.onload=async function(e){e=e.target.result;e.endsWith("\n")&&(e=e.slice(0,e.length-1));e=e.split("\n").map(f=>f.split(",")).map(f=>[Number(f[0]),Number(f[1])]);await KDB.storeData(c,e);alert("The repeated reading data has been successfully imported into the database.")};d.readAsText(b)}}catch(e){console.error("\u5bfc\u5165\u8fc7\u7a0b\u4e2d\u53d1\u751f\u9519\u8bef:",e),alert("An error occurred during the import process: "+e.message)}}else alert("Please select a file ending with .rp.txt")};
a.click()};KVR.importZipFileToDatabase=function(){function a(){document.body.removeChild(d);document.body.removeChild(b)}const b=document.createElement("div");b.className="fixed top-1/2 left-1/4 w-1/2 h-1 bg-gray-200 z-50";const c=document.createElement("div");c.className="w-0 h-5 bg-blue-500 rounded-full transition-all duration-300";b.appendChild(c);const d=document.createElement("div");d.className="fixed inset-0 w-full h-full bg-black bg-opacity-50 z-[9998]";const e=document.createElement("input");
e.type="file";e.accept=".zip";e.onchange=async function(f){f=f.target.files[0];if(f.name.endsWith(".zip"))try{document.body.appendChild(d);document.body.appendChild(b);var h=await JSZip.loadAsync(f);const k=Object.keys(h.files).length;console.log(`ZIP\u6587\u4ef6\u4e2d\u5171\u6709 ${k} \u4e2a\u6587\u4ef6`);f=0;for(const [g,l]of Object.entries(h.files)){f+=1;c.style.width=1*f/k*100+"%";if(l.dir)continue;h=g;g.endsWith(".rp.txt")&&(h=g.slice(0,-4));if(await KDB.checkKeyExists(h)){console.log(`'${h}'\u5df2\u5b58\u5728\u4e8e\u6570\u636e\u5e93\u4e2d\uff0c\u8df3\u8fc7`);
continue}const n=await l.async("arraybuffer");if(g.endsWith(".rp.txt")){let m=(new TextDecoder).decode(n);m.endsWith("\n")&&(m=m.slice(0,m.length-1));const q=m.split("\n").map(p=>p.split(",")).map(p=>[Number(p[0]),Number(p[1])]);await KDB.storeData(h,q)}else await KDB.storeData(h,n);console.log("import:",h);console.log(`'${h}'Successfully saved in the database`)}a();alert("Import successful, the page will be refreshed");window.location.reload()}catch(k){a(),console.error("An error occurred during the import:",
k),alert("An error occurred during the import:"+k.message)}else alert("Please select a .zip file")};e.click()};KVR.importAudioFromFileToDatabase=function(){document.getElementById("fileInput").click()};KVR.readAllKeysOfAudioDataBase=async function(){const a=await KDB.db[KDB.objectStorName].toCollection().keys();a.forEach(b=>{console.log("key="+b)});console.log("\u6570\u636e\u5e93\u4e2d\u5171\u6709"+a.length+"\u4e2akey");KVR.debugSubMenu.classList.add("hidden")};KVR.deleteAudioDatabase=async function(){try{await KDB.db.close(),
console.log("\u6570\u636e\u5e93\u5df2\u6210\u529f\u5173\u95ed")}catch(a){console.error("\u5173\u95ed\u6570\u636e\u5e93\u65f6\u53d1\u751f\u9519\u8bef:",a)}Dexie.delete(KDB.dataBaseName).then(()=>{console.log(`\u6570\u636e\u5e93 ${KDB.dataBaseName} \u5df2\u6210\u529f\u5220\u9664`);alert(`Database ${KDB.dataBaseName} Successfully deleted, page will be refreshed`);window.location.reload()}).catch(a=>{console.error(`\u5220\u9664\u6570\u636e\u5e93 ${KDB.dataBaseName} \u65f6\u53d1\u751f\u9519\u8bef:`,a);
alert(`An error occurred while deleting database ${KDB.dataBaseName}:`+a)})};KVR.readRPList=async function(a){a=await KDB.getData(a+".rp");let b=document.getElementById("rpList");a&&0<a.length&&a.forEach(function(c){let d=document.createElement("li");d.classList.add("py-2","px-3","hover:bg-gray-300","cursor-pointer","transition","duration-100");var e=c[0],f=c[1];let h=Math.floor(e/60);e=(e%60).toFixed(2);let k=Math.floor(f/60);f=(f%60).toFixed(2);d.textContent=`${h}:${e} - ${k}:${f}`;d.dataset.startTime=
c[0];d.dataset.endTime=c[1];d.addEventListener("click",function(){KVR.disableAudioControl();KVR.rpTimePointStart=c[0];KVR.rpTimePointEnd=c[1];b.querySelectorAll("li").forEach(g=>g.classList.remove("bg-green-200","text-green-800"));this.classList.add("bg-green-200","text-green-800");null!=KVR.intervalID&&(window.clearInterval(KVR.intervalID),KVR.intervalID=null);KVR.intervalID=window.setInterval(function(){KVR.audio.currentTime>=KVR.rpTimePointEnd?KVR.audio.currentTime=KVR.rpTimePointStart:KVR.audio.currentTime<=
KVR.rpTimePointStart&&(KVR.audio.currentTime=KVR.rpTimePointStart)},0);KVR.setButtonState("btnCntPlay",!1);KVR.setButtonState("btnRPSart",!1);KVR.setButtonState("btnRPEnd",!1);KVR.setButtonState("btnRPAdd",!1);KVR.setButtonState("btnReset",!0);KVR.setButtonRPColor("btnRPSart",!0);KVR.setButtonRPColor("btnRPEnd",!0)});d.addEventListener("contextmenu",function(g){g.preventDefault();KVR.showContextMenuRP(g,c[0],c[1])});b.appendChild(d)})};KVR.showContextMenu=function(a,b){let c=document.getElementById("contextMenu");
c.style.left=a.pageX+"px";c.style.top=a.pageY+"px";c.classList.remove("hidden");document.getElementById("deleteOption").onclick=function(){KVR.deleteAudioFromDatabase(b);c.classList.add("hidden")};document.addEventListener("click",function e(){c.classList.add("hidden");document.removeEventListener("click",e)})};KVR.deleteAudioFromDatabase=async function(a){try{await KDB.db[KDB.objectStorName].delete(a),console.log(`\u6210\u529f\u4ece\u6570\u636e\u5e93\u4e2d\u5220\u9664\u97f3\u9891: ${a}`),await KDB.db[KDB.objectStorName].delete(a+
".rp"),console.log(`\u6210\u529f\u4ece\u6570\u636e\u5e93\u4e2d\u5220\u9664\u590d\u8bfb\u8bb0\u5f55: ${a}.rp`),KVR.updatePlayList(),KVR.setBottomSutiableSize(),KVR.currentAudioName===a&&(KVR.updateRpList(KVR.currentAudioName),KVR.setBottomSutiableSize())}catch(b){console.error("\u5220\u9664\u6570\u636e\u5931\u8d25:",b)}};KVR.showContextMenuRP=function(a,b,c){let d=document.getElementById("contextMenuRP");d.style.left=a.pageX+"px";d.style.top=a.pageY+"px";d.classList.remove("hidden");document.getElementById("deleteOptionRP").onclick=
function(){KVR.deleteRepeatSegment(b,c);d.classList.add("hidden")};document.addEventListener("click",function f(){d.classList.add("hidden");document.removeEventListener("click",f)})};KVR.deleteRepeatSegment=async function(a,b){try{let c=await KDB.getData(KVR.currentAudioName+".rp");c&&Array.isArray(c)?(c=c.filter(d=>!(d[0]===a&&d[1]===b)),0>=c.length?(await KDB.db[KDB.objectStorName].delete(KVR.currentAudioName+".rp"),console.log(`\u5df2\u4ece\u6570\u636e\u5e93\u4e2d\u5220\u9664\u590d\u8bfb\u8bb0\u5f55: ${KVR.currentAudioName}.rp`)):
(c.sort((d,e)=>d[0]-e[0]),await KDB.storeData(KVR.currentAudioName+".rp",c),console.log("\u590d\u8bfb\u6bb5\u5df2\u6210\u529f\u5220\u9664\u5e76\u91cd\u65b0\u6392\u5e8f")),KVR.updateRpList(KVR.currentAudioName),KVR.setBottomSutiableSize()):console.log("\u672a\u627e\u5230\u590d\u8bfb\u70b9\u5217\u8868\u6216\u5217\u8868\u683c\u5f0f\u4e0d\u6b63\u786e")}catch(c){console.error("\u5220\u9664\u590d\u8bfb\u6bb5\u65f6\u51fa\u9519:",c)}};KVR.readPlayList=async function(){const a=await KDB.db[KDB.objectStorName].toCollection().keys();
let b=document.getElementById("playList");a.forEach(c=>{if(c.endsWith(".mp3")){var d=document.createElement("li");d.textContent=c;d.classList.add("py-2","px-3","hover:bg-gray-300","cursor-pointer","transition","duration-100");d.addEventListener("click",function(){KVR.isInRPState?alert("Currently in the repeating related state, please reset before switching."):(KVR.currentAudioName=d.textContent,KVR.WAVESURFER.stop(),KVR.readAudioAndPlay(KVR.currentAudioName),KVR.updateRpList(KVR.currentAudioName),
b.querySelectorAll("li").forEach(e=>e.classList.remove("bg-blue-200","text-blue-800")),this.classList.add("bg-blue-200","text-blue-800"))});d.addEventListener("contextmenu",function(e){e.preventDefault();KVR.showContextMenu(e,c)});b.appendChild(d)}})};KVR.updatePlayList=function(){document.getElementById("playList").innerHTML="";KVR.readPlayList()};KVR.updateRpList=function(a){document.getElementById("rpList").innerHTML="";KVR.readRPList(a);KVR.setBottomSutiableSize()};KVR.readAudioAndPlay=async function(a){var b=
await KDB.getData(a);b=new Blob([b],{type:"audio/mp3"});b=URL.createObjectURL(b);KVR.WAVESURFER.load(b);KVR.audio.src=b;KVR.currentAudioName=a;KVR.audio.play()};window.onload=function(){KVR.updatePlayList();setTimeout(function(){KVR.setBottomSutiableSize()},1E3)}})();
